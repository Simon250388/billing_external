#Область ПрограмныйИнтерфейс

Процедура СкорректироватьПотреблениеСезонныхУслуг(Организация, ПериодНачисления,Район,Строение,Помещение,Набор, НаборОбъемПомещений) Экспорт 
	Перем ДокументОбъект, НаборВыполненные, ТекЧастныйСектор, ТекМКД, ТекПериодНачисления, ЗамещатьНаборВыполненные;
	
	ГраницыПериода  						= энргРаботаСПериодомДействия.ГраницыРасчетногоПериода(Организация, ПериодНачисления,Ложь);
	МВТ  									= Новый МенеджерВременныхТаблиц;
	ЗаписыватьНаборыЗаписей 				= Набор = Неопределено;
	
	ПрочитатьВспомогательныеДанныеДляКорректировкиПотребленияСезонныхУслуг(МВТ,ГраницыПериода,Организация,ПериодНачисления,Район,Ложь,Строение,Помещение);
	
	Запрос 									= Новый Запрос;
	Запрос.МенеджерВременныхТаблиц 			= МВТ;
	Запрос.Текст 							= ТекстЗапросаДанныеДляКорректировкаПотребленияСезонныхУслуг();
	Результат  								= Запрос.Выполнить();
	
	Выборка  								= Результат.Выбрать();
	ТекЗавершениеОП 						= ГраницыПериода.ЗавершениеОП-1;
	
	Если Выборка.Количество() = 0 Тогда		
		ВыборкаДокументыОтменить 			= РезультатОтменитьКорректировкуСезонныхУслуг(ПериодНачисления,Организация,Район,Строение);
		Пока ВыборкаДокументыОтменить.Следующий() Цикл
			ДокументОбъектОтменить			= ВыборкаДокументыОтменить.Ссылка.ПолучитьОбъект();
			ДокументОбъектОтменить.УстановитьПометкуУдаления(Истина);			
		КонецЦикла;		
		РегистрыСведений.энргДокументыНачислений.УстановитьПометкуУдаленияДокументаНачислений(ПериодНачисления, Организация, Район, Строение, Перечисления.энргВидыОперацийНачисления.КорректировкаПотребленияСезонныхУслуг);
		Возврат;
	КонецЕсли;
	
	Ошибки 									= "";
	Пока Выборка.Следующий() Цикл
		
		Если НЕ ТекМКД = Выборка.МКД Тогда
			
			Если НЕ ТекМКД = Неопределено Тогда
				Попытка 					
					энргНачисления.ЗаписатьНаборыЗаписейНачисление(ДокументОбъект, Набор, НаборВыполненные, НаборОбъемПомещений, Ошибки);
				Исключение
					ИнформацияОбОшибке  	= ИнформацияОбОшибке();
					Ошибки 					= Ошибки + Символы.ПС + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке);
				КонецПопытки;
			КонецЕсли;
			
			энргНачисления.ПрочитатьНаборыЗаписейНачисление(Выборка,ДокументОбъект,Помещение,Набор,НаборОбъемПомещений,НаборВыполненные, Перечисления.энргВидыОперацийНачисления.КорректировкаПотребленияСезонныхУслуг);
		КонецЕсли;
		
		СтрокаНабора 						= Набор.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаНабора,Выборка);
		СтрокаНабора.Период 				= ТекЗавершениеОП;
		
		ТекПериодНачисления 				= Выборка.Организация;
		ТекЧастныйСектор					= Выборка.ЧастныйСектор;
		ТекМКД 								= Выборка.МКД;
	КонецЦикла;
	
	энргНачисления.ЗаписатьНаборыЗаписейНачисление(ДокументОбъект, Набор, НаборВыполненные, НаборОбъемПомещений, Ошибки);
		
	Если Не ПустаяСтрока(Ошибки) Тогда
		ВызватьИсключение Ошибки;
	КонецЕсли;
	
КонецПроцедуры

// Процедура - Снять средние начисления
//
// Параметры:
//  ПериодНачисления - 	 - 
//  Район			 - 	 - 
//  ЧастныйСектор	 - 	 - 
//  Строение		 - 	 - 
//  Помещение		 - 	 - 
//  Документ		 - 	 - 
//
Процедура СнятьСредниеНачисления(Организация,ПериодНачисления,Район,ЧастныйСектор,Строение,Помещение,Документ) Экспорт
	перем ТекСтроение,ТекЧастныйСектор,ДокументОбъект; 
	
	Если не ЗначениеЗаполнено(ПериодНачисления) или не ЗначениеЗаполнено(Район)  тогда
		Возврат;
	КонецЕсли;
	
	ГраницыПериода  								= энргРаботаСПериодомДействия.ГраницыРасчетногоПериода(Организация, ПериодНачисления);
	
	НачалоПериодаРасчета							= ГраницыПериода.НачалоОП;
	КонецПериодаРасчета  							= ГраницыПериода.ЗавершениеОП;
	      	
	МВТ  											= Новый МенеджерВременныхТаблиц;
	ПрочитатьНеСписанныйСредний(МВТ,ПериодНачисления,Организация,Район,ЧастныйСектор,Строение,Помещение,НачалоПериодаРасчета);	
	результатЗапроса 								= РезультатЗапросаПерерасчетСреднего(МВТ,Организация, ПериодНачисления, КонецПериодаРасчета-1,Район,ЧастныйСектор,Строение,Помещение); 	
	
	Выборка  										= результатЗапроса.выбрать();
	ВидОперации 									= Перечисления.энргВидыОпераций.энргПерерасчет_СвязанныйПерерасчет;
	Сч 												= 0;
	
	Набор 											= Неопределено;
	НаборНачисленныйСредний 						= Неопределено;
	НаборВыполненные 								= Неопределено;
	ВидНачисленияПерерасчет 						= Перечисления.энргВидыНачислений.Перерасчет;
	
	Если Выборка.Количество() = 0 Тогда				
		ВыборкаДокументыОтменить 					= РезультатОтменитьСнятьСредниеНачисления(ПериодНачисления,Организация,Район,ЧастныйСектор,Строение);
		Пока ВыборкаДокументыОтменить.Следующий() Цикл				
			ДокументОбъектОтменить					= ВыборкаДокументыОтменить.Ссылка.ПолучитьОбъект();
			Если Помещение = Неопределено Тогда
				ДокументОбъектОтменить.УстановитьПометкуУдаления(Истина);
			Иначе
				// надо удалить движения с этим помещением
				Набор								= РегистрыНакопления.энргОбъемНачислений.СоздатьНаборЗаписей();
				Набор.Отбор.Регистратор.Установить(ВыборкаДокументыОтменить.Ссылка);
				Набор.Прочитать();
				
				СтрокиНабораДоЗаписи 		= Набор.Выгрузить();
				СтрокиУдалить 				= СтрокиНабораДоЗаписи.НайтиСтроки(Новый Структура("Строение,Помещение", Строение, Помещение));
				Если СтрокиУдалить.Количество() <> 0 Тогда
					
					НаборНачисленныйСредний 			= РегистрыНакопления.энргНачисленныйСреднийОбъем.СоздатьНаборЗаписей();
					НаборНачисленныйСредний.Отбор.Регистратор.Установить(ВыборкаДокументыОтменить.Ссылка);
					
					НаборНачисленныйСредний.ДополнительныеСвойства.Вставить("Помещение",	Помещение);
					НаборНачисленныйСредний.Прочитать();
					СтрокиНаборНачисленныйСреднийДоЗаписи 			= НаборНачисленныйСредний.Выгрузить();
					СтрокиУдалитьСреднего		= СтрокиНаборНачисленныйСреднийДоЗаписи.НайтиСтроки(Новый Структура("Строение,Помещение", Строение, Помещение));
					Для Каждого СтрокаУдалить ИЗ СтрокиУдалитьСреднего Цикл
						СтрокиНаборНачисленныйСреднийДоЗаписи.Удалить(СтрокаУдалить);
					КонецЦикла;
					НаборНачисленныйСредний.Загрузить(СтрокиНаборНачисленныйСреднийДоЗаписи);
					
					Для Каждого СтрокаУдалить ИЗ СтрокиУдалить Цикл
						СтрокиНабораДоЗаписи.Удалить(СтрокаУдалить);
					КонецЦикла;
					
					Набор.Загрузить(СтрокиНабораДоЗаписи);
					Набор.ДополнительныеСвойства.Вставить("Помещение",			Помещение);
					Набор.ДополнительныеСвойства.Вставить("Организация",		Организация);
					Набор.ДополнительныеСвойства.Вставить("Район",				Район);
					Набор.ДополнительныеСвойства.Вставить("ПериодНачисления",	ПериодНачисления);
					Набор.ДополнительныеСвойства.Вставить("Строение",			?(Строение.ТипСтроения = Перечисления.энргТипыСтроений.МКД, Строение, Справочники.энргСтроения.ПустаяСсылка()));
					Набор.ДополнительныеСвойства.Вставить("ДатаРегистратора",	КонецПериодаРасчета-1);
					Набор.ДополнительныеСвойства.Вставить("НаборНачисленныйСредний", НаборНачисленныйСредний);
					
					Набор.Записать();
				КонецЕсли;
			КонецЕсли;
		КонецЦикла; 		
	КонецЕсли; 		
	
	СтрокиНабораДоЗаписи 							= Неопределено;
	СтрокиНаборНачисленныйСреднийДоЗаписи 			= Неопределено;
	Ошибки 											= "";
	
	Пока Выборка.следующий() цикл
		Если ТипЗнч(Документ) = Тип("Структура") И  Документ.Свойство("ОбъемНачислений") Тогда
			НаборНачисленныйСредний 				= Неопределено;    
			Набор 									= Документ.ОбъемНачислений;
		ИначеЕсли Документ = Неопределено тогда
			Если Не ТекЧастныйСектор = Выборка.ЧастныйСектор ИЛИ (НЕ ТекЧастныйСектор и Не ТекСтроение = Выборка.Строение) тогда 				
				Если Не ТекСтроение = Неопределено Тогда					
					Попытка
						Если ДокументОбъект<>Неопределено тогда
							ДокументОбъект.ДополнительныеСвойства.Вставить("НеПроверятьНаличиеПрисоединенныхФайлов", 	Истина);
							ДокументОбъект.ДополнительныеСвойства.Вставить("НеРегестрироватьВзаиморасчеты", 			Истина);
							ДокументОбъект.ДополнительныеСвойства.Вставить("ПроведениеРазрешено",						Истина);
							ДокументОбъект.ДополнительныеСвойства.Вставить("РегистрироватьПоказанияПУ", 				Ложь);
							ДокументОбъект.ДополнительныеСвойства.Вставить("РегистрироватьСтабильныеПериоды", 			Ложь);
							ДокументОбъект.записать(РежимЗаписиДокумента.Запись);										
						КонецЕсли;
						
						Набор.ДополнительныеСвойства.Вставить("Организация",				Организация);
						Набор.ДополнительныеСвойства.Вставить("Район",						Район);
						Набор.ДополнительныеСвойства.Вставить("ПериодНачисления",			ПериодНачисления);
						Набор.ДополнительныеСвойства.Вставить("Строение",					?(ТекЧастныйСектор, Справочники.энргСтроения.ПустаяСсылка(), ТекСтроение));
						Набор.ДополнительныеСвойства.Вставить("ДатаРегистратора",			КонецПериодаРасчета-1);
						Набор.ДополнительныеСвойства.Вставить("НаборНачисленныйСредний", 	НаборНачисленныйСредний);
						Набор.ДополнительныеСвойства.Вставить("НаборВыполненные", 			НаборВыполненные);
						Набор.Записать(Ложь);
						
						Если НЕ НаборВыполненные = Неопределено Тогда
							НаборВыполненные.Записать(НаборВыполненные.ДополнительныеСвойства.Замещать);
						КонецЕсли;
						
						ЗафиксироватьТранзакцию();						 						
					Исключение
						ОтменитьТранзакцию();
						ИнформацияОбОшибке  		= ИнформацияОбОшибке();
						Ошибки 						= Ошибки +
						Символы.ПС + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке);
					КонецПопытки;
				КонецЕсли;
				НачатьТранзакцию();
				ДокументСсылка 						= Выборка.ДокументПерерасчета;
				ПометкаУдаления 					= Выборка.ДокументПерерасчетаПометкаУдаления;
				ДокументОбъект  					= Неопределено;
				МКД 								= ?(Выборка.ЧастныйСектор, Справочники.энргСтроения.ПустаяСсылка(), Выборка.Строение);
				
				Если НЕ ЗначениеЗаполнено(ДокументСсылка)  Тогда
					ДокументСсылка 					= Документы.энргПерерасчет.ПолучитьСсылку(Новый УникальныйИдентификатор());
					ДокументОбъект  				= Документы.энргПерерасчет.СоздатьДокумент();
					ДокументОбъект.УстановитьСсылкуНового(ДокументСсылка);
					ДокументОбъект.район  			= Район;
					ДокументОбъект.Строение			= МКД;
					ДокументОбъект.Дата				= КонецПериодаРасчета-1;
					ДокументОбъект.Организация 		= Организация;
					ДокументОбъект.ВидОперации 		= Перечисления.энргВидыОпераций.энргПерерасчет_СвязанныйПерерасчет;
					ДокументОбъект.ПериодНачисления = ПериодНачисления;
					
					НаборВыполненные 							= РегистрыСведений.энргДокументыНачислений.СоздатьНаборЗаписей();
					НаборВыполненныеДопСвойства 				= НаборВыполненные.ДополнительныеСвойства;
					НаборВыполненныеДопСвойства.Вставить("Замещать", Ложь);
					
					ЗаписьВыполненные							= НаборВыполненные.Добавить();
					ЗаписьВыполненные.Организация 				= Организация;
					ЗаписьВыполненные.Район		 				= Район;
					ЗаписьВыполненные.ПериодНачисления 			= ПериодНачисления;
					ЗаписьВыполненные.ВидОперацийНачисления		= Перечисления.энргВидыОперацийНачисления.ПерерасчетСредних;
					ЗаписьВыполненные.МКД 						= МКД;
					ЗаписьВыполненные.ДокументНачисления 		= ДокументСсылка;		
					
				ИначеЕсли ПометкаУдаления Тогда
					ДокументОбъект  				= ДокументСсылка.ПолучитьОбъект();
					ДокументОбъект.ПометкаУдаления 	= Ложь;   					
					
					НаборВыполненные 							= РегистрыСведений.энргДокументыНачислений.СоздатьНаборЗаписей();
					
					НаборВыполненные.Отбор.Организация.Установить(Организация);
					НаборВыполненные.Отбор.ПериодНачисления.Установить(ПериодНачисления);
					НаборВыполненные.Отбор.Район.Установить(Район);
					НаборВыполненные.Отбор.ВидОперацийНачисления.Установить(Перечисления.энргВидыОперацийНачисления.ПерерасчетСредних);
					НаборВыполненные.Отбор.МКД.Установить(МКД);
					НаборВыполненныеДопСвойства 				= НаборВыполненные.ДополнительныеСвойства;
					НаборВыполненныеДопСвойства.Вставить("Замещать", Истина);
					
					ЗаписьВыполненные							= НаборВыполненные.Добавить();
					ЗаписьВыполненные.Организация 				= Организация;
					ЗаписьВыполненные.Район		 				= Район;
					ЗаписьВыполненные.ПериодНачисления 			= ПериодНачисления;
					ЗаписьВыполненные.ВидОперацийНачисления 	= Перечисления.энргВидыОперацийНачисления.ПерерасчетСредних;
					ЗаписьВыполненные.МКД 						= МКД;
					ЗаписьВыполненные.ДокументНачисления 		= ДокументСсылка;
					ЗаписьВыполненные.ПометкаУдаления	 		= Ложь;					
				КонецЕсли;
				 							 
				НаборНачисленныйСредний 			= РегистрыНакопления.энргНачисленныйСреднийОбъем.СоздатьНаборЗаписей();
				НаборНачисленныйСредний.Отбор.Регистратор.Установить(ДокументСсылка);
				
				Если Не Помещение = Неопределено Тогда					
					НаборНачисленныйСредний.ДополнительныеСвойства.Вставить("Помещение",	Помещение);
					Если ДокументОбъект = Неопределено Тогда
						НаборНачисленныйСредний.Прочитать();
						СтрокиНаборНачисленныйСреднийДоЗаписи 			= НаборНачисленныйСредний.Выгрузить();
						СтрокиУдалить 									= СтрокиНаборНачисленныйСреднийДоЗаписи.НайтиСтроки(Новый Структура("Помещение", Помещение));
						Для Каждого СтрокаУдалить ИЗ СтрокиУдалить Цикл
							СтрокиНаборНачисленныйСреднийДоЗаписи.Удалить(СтрокаУдалить);
						КонецЦикла;
						НаборНачисленныйСредний.Очистить();
					КонецЕсли;					
				КонецЕсли;
								
				Если ДокументОбъект = Неопределено Тогда
					НаборНачисленныйСредний.Записать();
				КонецЕсли;
								
				Набор								= РегистрыНакопления.энргОбъемНачислений.СоздатьНаборЗаписей();
				Набор.Отбор.Регистратор.Установить(ДокументСсылка);
				
				Если Не Помещение = Неопределено Тогда					
					Набор.ДополнительныеСвойства.Вставить("Помещение",	Помещение);
					Если ДокументОбъект = Неопределено Тогда
						Набор.Прочитать();
						СтрокиНабораДоЗаписи 		= Набор.Выгрузить();
						СтрокиУдалить 				= СтрокиНабораДоЗаписи.НайтиСтроки(Новый Структура("Помещение", Помещение));
						Для Каждого СтрокаУдалить ИЗ СтрокиУдалить Цикл
							СтрокиНабораДоЗаписи.Удалить(СтрокаУдалить);
						КонецЦикла;
						Набор.Очистить();
					КонецЕсли;					
				КонецЕсли;
								
				Если ДокументОбъект = Неопределено Тогда
					Набор.Записать();
				КонецЕсли;				
			КонецЕсли;
		иначе
			Если ДокументОбъект = Неопределено Тогда
				НачатьТранзакцию();
				ДокументСсылка						= Документ.Ссылка;
				ДокументОбъект 						= ДокументСсылка.ПолучитьОбъект();
				
				НаборНачисленныйСредний 			= РегистрыНакопления.энргНачисленныйСреднийОбъем.СоздатьНаборЗаписей();
				НаборНачисленныйСредний.Отбор.Регистратор.Установить(ДокументСсылка);
				НаборНачисленныйСредний.Очистить();
				
				Набор								= РегистрыНакопления.энргОбъемНачислений.СоздатьНаборЗаписей();
				Набор.Отбор.Регистратор.Установить(ДокументСсылка);
				Набор.Очистить();
			КонецЕсли;
			
			//ДокументОбъект 							= Документ;
			//ОбъемНачислений 						= ДокументОбъект.СвязанныйПерерасчет;
		КонецЕсли;	
		
		Если НаборНачисленныйСредний <> Неопределено Тогда
			СтрокаНабора 							= НаборНачисленныйСредний.добавитьРасход();
			ЗаполнитьЗначенияСвойств(СтрокаНабора,Выборка);
			СтрокаНабора.Период 					= ГраницыПериода.ЗавершениеОП - 1;
			СтрокаНабора.Организация 				= Организация;
		КонецЕсли;
		
		// ЗначениеТарифа = ?(ЗначениеЗаполнено(Выборка.Сумма),Выборка.ОбъемУслугиНачислено/Выборка.СуммаНачислено,0);
		//ЗначениеТарифа 								= Выборка.ЗначениеТарифаНачислено;
		ЗначениеТарифа 								= Выборка.ЗначениеТарифа;
		
		СтрокаНабора 								= Набор.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаНабора,Выборка);
		СтрокаНабора.Период 						= ГраницыПериода.ЗавершениеОП - 1;
		СтрокаНабора.Организация 					= Организация;
		СтрокаНабора.ВидНачисления 					= ВидНачисленияПерерасчет;
		СтрокаНабора.ОбъемУслуги 					= -Выборка.ОбъемУслуги;
		СтрокаНабора.ОбъемУслугиПотребленный 		= -Выборка.ОбъемУслугиПотребленный;
		СтрокаНабора.Сумма		 					= -Выборка.ОбъемУслуги*ЗначениеТарифа;
		СтрокаНабора.ПериодРасчета					= ПериодНачисления;
		СтрокаНабора.ПериодНачисления				= Выборка.ПериодНачисления;
		
		ТекЧастныйСектор 							= Выборка.ЧастныйСектор;
		ТекСтроение									= Выборка.Строение;
		Сч 											= Сч + 1;
	КонецЦикла;	
		 
	Если Не ТекСтроение = Неопределено И ТипЗнч(Документ) <> Тип("Структура") Тогда					
		Попытка
			Если ДокументОбъект<>Неопределено тогда
				ДокументОбъект.ДополнительныеСвойства.Вставить("НеПроверятьНаличиеПрисоединенныхФайлов", 	Истина);
				ДокументОбъект.ДополнительныеСвойства.Вставить("НеРегестрироватьВзаиморасчеты", 			Истина);
				ДокументОбъект.ДополнительныеСвойства.Вставить("ПроведениеРазрешено",						Истина);
				ДокументОбъект.ДополнительныеСвойства.Вставить("РегистрироватьПоказанияПУ", 				Ложь);
				ДокументОбъект.ДополнительныеСвойства.Вставить("РегистрироватьСтабильныеПериоды", 			Ложь);
				ДокументОбъект.записать(РежимЗаписиДокумента.Запись);										
			КонецЕсли;
			
			Если Набор.Количество() > 0 Тогда
				Набор.ДополнительныеСвойства.Вставить("Организация",		Организация);
				Набор.ДополнительныеСвойства.Вставить("Район",				Район);
				Набор.ДополнительныеСвойства.Вставить("ПериодНачисления",	ПериодНачисления);
				Набор.ДополнительныеСвойства.Вставить("Строение",			?(ТекЧастныйСектор, Справочники.энргСтроения.ПустаяСсылка(), ТекСтроение));
				Набор.ДополнительныеСвойства.Вставить("ДатаРегистратора",	КонецПериодаРасчета-1);
				
				Если НЕ Помещение = Неопределено и НЕ СтрокиНабораДоЗаписи = Неопределено и СтрокиНабораДоЗаписи.Количество() > 0 Тогда
					Набор.ДополнительныеСвойства.Вставить("Помещение",	Помещение);
					Для Каждого СтрокаДобавить Из СтрокиНаборНачисленныйСреднийДоЗаписи Цикл
						ЗаполнитьЗначенияСвойств(НаборНачисленныйСредний.Добавить(), СтрокаДобавить);
					КонецЦикла;
					
					Для Каждого СтрокаДобавить Из СтрокиНабораДоЗаписи Цикл
						ЗаполнитьЗначенияСвойств(Набор.Добавить(), СтрокаДобавить);
					КонецЦикла;				
				КонецЕсли;
				
				Набор.ДополнительныеСвойства.Вставить("НаборНачисленныйСредний", НаборНачисленныйСредний);			
				Набор.Записать(Ложь);
				
				Если НЕ НаборВыполненные = Неопределено Тогда
					НаборВыполненные.Записать(НаборВыполненные.ДополнительныеСвойства.Замещать);
				КонецЕсли;				
			КонецЕсли;
			ЗафиксироватьТранзакцию();
		Исключение
			ОтменитьТранзакцию();
			ИнформацияОбОшибке  					= ИнформацияОбОшибке();
			Ошибки 									= Ошибки +
			Символы.ПС + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке);
		КонецПопытки;
	КонецЕсли;  
	 	
	Если Не ПустаяСтрока(Ошибки) Тогда
		ВызватьИсключение Ошибки;
	КонецЕсли;
	
КонецПроцедуры

Процедура СнятьСредниеНачисленияМКД(Организация,ПериодНачисления,Район,МКД,Документ) Экспорт
	перем ТекМКД,ДокументОбъект; 
	
	Если не ЗначениеЗаполнено(ПериодНачисления) или не ЗначениеЗаполнено(Район)  тогда
		Возврат;
	КонецЕсли;
	
	ГраницыПериода  								= энргРаботаСПериодомДействия.ГраницыРасчетногоПериода(Организация, ПериодНачисления);
	
	НачалоПериодаРасчета							= ГраницыПериода.НачалоОП;
	КонецПериодаРасчета  							= ГраницыПериода.ЗавершениеОП;
	
	МВТ  											= Новый МенеджерВременныхТаблиц;
	ПрочитатьНеСписанныйСреднийМКД(МВТ,Организация,Район,МКД,НачалоПериодаРасчета);	
	результатЗапроса 								= РезультатЗапросаПерерасчетСреднегоМКД(МВТ,Организация, ПериодНачисления,Район,МКД); 	
	
	Выборка  										= результатЗапроса.выбрать();
	ВидОперации 									= Перечисления.энргВидыОпераций.энргПерерасчетМКД_СвязанныйПерерасчет;
	Набор 											= Неопределено;
	НаборНачисленныйСредний 						= Неопределено;
	ДокументСсылка 									= Неопределено;
	
	ВидНачисленияПерерасчет							= Перечисления.энргВидыНачислений.Перерасчет;
	
	Пока Выборка.следующий() цикл
		Если Документ = Неопределено тогда			
			Если  ДокументСсылка = Неопределено Тогда
				ДокументСсылка 						= Выборка.ДокументПерерасчета;
				ДокументОбъект 						= Неопределено;
				Если НЕ ЗначениеЗаполнено(ДокументСсылка) тогда					
					ДокументСсылка 					= Документы.энргПерерасчетМКД.ПолучитьСсылку(Новый УникальныйИдентификатор());
					ДокументОбъект  				= Документы.энргПерерасчетМКД.СоздатьДокумент();
					ДокументОбъект.УстановитьСсылкуНового(ДокументСсылка);
					ДокументОбъект.район  			= Район;
					ДокументОбъект.Дата				= КонецПериодаРасчета-1;
					ДокументОбъект.Организация 		= Организация;
					ДокументОбъект.ВидОперации 		= ВидОперации;
				КонецЕсли;
							 
				НаборНачисленныйСредний 			= РегистрыНакопления.энргНачисленныйСреднийОбъемМКД.СоздатьНаборЗаписей();
				НаборНачисленныйСредний.Отбор.Регистратор.Установить(ДокументСсылка);
				НаборНачисленныйСредний.Записать();
				
				Набор								= РегистрыНакопления.энргОбъемНачисленийМКД.СоздатьНаборЗаписей();
				Набор.Отбор.Регистратор.Установить(ДокументСсылка);
				Набор.Записать();				
			КонецЕсли;
		иначе
			Набор 									= Документ.Движения.энргНачисленныйСреднийОбъемМКД;
			Набор.Очистить(); 			
		КонецЕсли;		
		
		СтрокаНабора 								= НаборНачисленныйСредний.добавитьРасход();
		ЗаполнитьЗначенияСвойств(СтрокаНабора,Выборка);
		СтрокаНабора.Период 						= ГраницыПериода.ЗавершениеОП - 1;
		СтрокаНабора.Организация 					= Организация;
		
		СтрокаНабора 								= Набор.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаНабора,Выборка);
		СтрокаНабора.Период 						= ГраницыПериода.ЗавершениеОП - 1;
		СтрокаНабора.Организация 					= Организация;
		СтрокаНабора.ВидНачисления 					= ВидНачисленияПерерасчет;
		СтрокаНабора.ОбъемУслуги 					= - Выборка.ОбъемУслуги;
		СтрокаНабора.ПериодРасчета					= ГраницыПериода.ПериодНачисления;
	КонецЦикла;	
		
	Если Документ = Неопределено И Не Набор = Неопределено и Набор.Количество() > 0 тогда
		НачатьТранзакцию();
		Попытка
			Если Не ДокументОбъект = Неопределено Тогда
				ДокументОбъект.ДополнительныеСвойства.Вставить("ПроведениеРазрешено",Истина);
				ДокументОбъект.записать(РежимЗаписиДокумента.Проведение);
			КонецЕсли;
			Набор.ДополнительныеСвойства.Вставить("Организация",			Организация);
			Набор.ДополнительныеСвойства.Вставить("Район",					Район);
			Набор.ДополнительныеСвойства.Вставить("ПериодНачисления",		ПериодНачисления);
			Набор.ДополнительныеСвойства.Вставить("ДатаРегистратора",		КонецПериодаРасчета-1);
			Набор.ДополнительныеСвойства.Вставить("ИзменятьОбъемНачислений", Истина);
			Набор.ДополнительныеСвойства.Вставить("НаборНачисленныйСредний", НаборНачисленныйСредний);
			Набор.Записать(Ложь);						
			ЗафиксироватьТранзакцию();
		Исключение
			ОписаниеОшибки 							= ИнформацияОбОшибке();
			ОтменитьТранзакцию();
			ВызватьИсключение ПодробноеПредставлениеОшибки(ОписаниеОшибки);
		КонецПопытки;
	КонецЕсли; 
	
КонецПроцедуры

Процедура СкорректироватьПотреблениеСезонныхУслугМКД(Организация, ПериодНачисления,Район,Строение,Набор) Экспорт 
		
КонецПроцедуры

Процедура ИзменитьПризнакСостояниеПрибора(Делегат) Экспорт 
	
	ПолучаемыеНаборы 				= Новый Массив;
	
	ПолучаемыеНаборы.Добавить(Новый Структура("ИмяНабора,ТаблицаДляПомещения","НастройкаСезонностиУслугВПериодеНачисления",		"НастройкаСезонностиУслуг"));
	ПолучаемыеНаборы.Добавить(Новый Структура("ИмяНабора,ТаблицаДляПомещения","ТочкиУчетаСИзменившимсяСостояниемПрибораУчета",	"ТочкиУчетаСИзменившимсяСостояниемПрибораУчета"));
	ПолучаемыеНаборы.Добавить(Новый Структура("ИмяНабора,ТаблицаДляПомещения","НаборЗаписейОбъемаНачисленийЗаПериод",			"НаборЗаписейОбъемаНачисленийЗаПериод"));
	ПолучаемыеНаборы.Добавить(Новый Структура("ИмяНабора,ТаблицаДляПомещения","ДокументыПерерасчета",							"ДокументыПерерасчета"));
		
	МВТ 							= Новый МенеджерВременныхТаблиц;
	Делегат.Инициализировать(МВТ,ПолучаемыеНаборы);
	
	Запрос  						= Новый Запрос(ТекстЗапросаИзменитьПризнакСостояниеПрибора());
	Запрос.МенеджерВременныхТаблиц 	= МВТ;
	Результат  						= Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	ОбработатьРезультатЗапросаИзменитьПризнакСостояниеПрибора(Результат, Делегат);	
	
КонецПроцедуры

Функция ЗаполнитьПоказанияДляПерерасчета(Организация,Район,Абонент,ПериодНачисленияКонец,Основания,Приемник,ИмяСвойства) Экспорт  
	
	Запрос  		= Новый Запрос;
	Запрос.УстановитьПараметр("Район",					Район);
	Запрос.УстановитьПараметр("Абонент",				Абонент);
	Запрос.УстановитьПараметр("ПериодНачисленияКонец",	ПериодНачисленияКонец);
	Запрос.УстановитьПараметр("ДокументыОснования",		Основания);
	Запрос.Текст 	="ВЫБРАТЬ
	|	ВложенныйЗапрос.ПриборУчета КАК ПриборУчетаДо,
	|	ВложенныйЗапрос.Период КАК ДатаПоказаний,
	|	ВложенныйЗапрос.Регистратор КАК РегистраторПоказаний,
	|	ВложенныйЗапрос.Показание КАК ПоказанияДо,
	|	ВложенныйЗапрос.СостояниеПоказаний КАК СостояниеПоказанийДо,
	|	ВложенныйЗапрос.Переворот КАК ПереворотДо,
	|	ВложенныйЗапрос.ПриборУчета КАК ПриборУчетаПосле,
	|	ВложенныйЗапрос.Показание КАК ПоказанияПосле,
	|	ВложенныйЗапрос.СостояниеПоказаний КАК СостояниеПоказанийПосле,
	|	ВложенныйЗапрос.Переворот КАК ПереворотПосле,
	|	ВложенныйЗапрос.ДатаРегистратора,
	|	ЕСТЬNULL(энргПредоставленныеПоказания.ВСрок, ЛОЖЬ) КАК ВСрокДо
	|ИЗ
	|	(ВЫБРАТЬ
	|		энргПоказанияПриборовУчета.ПриборУчета КАК ПриборУчета,
	|		энргПоказанияПриборовУчета.Период КАК Период,
	|		энргПоказанияПриборовУчета.Регистратор КАК Регистратор,
	|		энргПоказанияПриборовУчета.Разделитель КАК Разделитель,
	|		энргПоказанияПриборовУчета.Показание КАК Показание,
	|		энргПоказанияПриборовУчета.СостояниеПоказаний КАК СостояниеПоказаний,
	|		энргПоказанияПриборовУчета.КС КАК КС,
	|		энргПоказанияПриборовУчета.Переворот КАК Переворот,
	|		энргПоказанияПриборовУчета.ПериодРегистрации КАК ДатаРегистратора
	|	ИЗ
	|		РегистрСведений.энргПоказанияПриборовУчета КАК энргПоказанияПриборовУчета
	|	ГДЕ
	|		энргПоказанияПриборовУчета.Организация = &Организация
	|		И энргПоказанияПриборовУчета.Район = &Район
	|		И энргПоказанияПриборовУчета.Абонент = &Абонент
	|		И энргПоказанияПриборовУчета.ПериодНачисления <= &ПериодНачисленияКонец
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		энргПоказанияПриборовУчета.ПриборУчета,
	|		энргПоказанияПриборовУчета.Период,
	|		энргПоказанияПриборовУчета.Регистратор,
	|		энргПоказанияПриборовУчета.Разделитель,
	|		энргПоказанияПриборовУчета.Показание,
	|		энргПоказанияПриборовУчета.СостояниеПоказаний,
	|		энргПоказанияПриборовУчета.КС,
	|		энргПоказанияПриборовУчета.Переворот,
	|		энргПоказанияПриборовУчета.ПериодРегистрации
	|	ИЗ
	|		РегистрСведений.энргПоказанияПриборовУчета КАК энргПоказанияПриборовУчета
	|	ГДЕ
	|		энргПоказанияПриборовУчета.Организация = &Организация
	|		И энргПоказанияПриборовУчета.Район = &Район
	|		И энргПоказанияПриборовУчета.Абонент = &Абонент
	|		И энргПоказанияПриборовУчета.Регистратор В(&ДокументыОснования)) КАК ВложенныйЗапрос
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.энргОтклоненныеПерерасчетомПоказания КАК энргОтклоненныеПерерасчетомПоказания
	|		ПО ВложенныйЗапрос.Регистратор = энргОтклоненныеПерерасчетомПоказания.РегистраторПоказаний
	|			И ВложенныйЗапрос.ПриборУчета = энргОтклоненныеПерерасчетомПоказания.ПриборУчета
	|			И ВложенныйЗапрос.Разделитель = энргОтклоненныеПерерасчетомПоказания.Разделитель
	|			И (энргОтклоненныеПерерасчетомПоказания.ПериодНачисления <= &ПериодНачисленияКонец)
	|			И (энргОтклоненныеПерерасчетомПоказания.Район = &Район)
	|			И (энргОтклоненныеПерерасчетомПоказания.Абонент = &Абонент)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.энргПредоставленныеПоказания КАК энргПредоставленныеПоказания
	|		ПО ВложенныйЗапрос.Регистратор = энргПредоставленныеПоказания.ДокРегистратор
	|			И ВложенныйЗапрос.ПриборУчета = энргПредоставленныеПоказания.ПриборУчета
	|			И ВложенныйЗапрос.Разделитель = энргПредоставленныеПоказания.Разделитель
	|			И (энргПредоставленныеПоказания.Организация = &Организация)
	|			И (энргПредоставленныеПоказания.ПериодНачисления <= &ПериодНачисленияКонец)
	|			И (энргПредоставленныеПоказания.Район = &Район)
	|			И (энргПредоставленныеПоказания.Абонент = &Абонент)
	|ГДЕ
	|	энргОтклоненныеПерерасчетомПоказания.Район ЕСТЬ NULL 
	|
	|УПОРЯДОЧИТЬ ПО
	|	ВложенныйЗапрос.ПриборУчета,
	|	ВложенныйЗапрос.Период,
	|	ВложенныйЗапрос.Регистратор";
	
	Результат  		= Запрос.Выполнить();
	Выборка 		= Результат.Выбрать();
	
	ТабличнаяЧасть 	= Приемник[ИмяСвойства];
	ТабличнаяЧасть.очистить();
	
	Пока Выборка.Следующий() цикл
		ЗаполнитьЗначенияСвойств(ТабличнаяЧасть.добавить(),Выборка);
	КонецЦикла;  
	
КонецФункции

#КонецОбласти

#Область ВспомогательныеПроцедурыИФункции

Процедура ПрочитатьВспомогательныеДанныеДляКорректировкиПотребленияСезонныхУслуг(МВТ,ГраницыПериода,Организация,ПериодНачисления,Район,ГодоваяКорректировка,Строение,Помещение)
	
	Запрос 							= Новый Запрос();	
	Текст 							= ТекстЗапросаВспомогательныеДанныеДляКорректировкиПотребленияСезонныхУслуг();
	
	Если НЕ Помещение = Неопределено Тогда	
		ЧастныйСектор 				= НЕ ЗначениеЗаполнено(Строение);
		Запрос.УстановитьПараметр("ЧастныйСектор", 	ЧастныйСектор);
		Запрос.УстановитьПараметр("Строение",		Строение);
		Запрос.УстановитьПараметр("Помещение",		Помещение);
		Запрос.УстановитьПараметр("МКД",			?(ЧастныйСектор,Справочники.энргСтроения.ПустаяСсылка(),Строение));

	ИначеЕсли Не Строение = Неопределено И НЕ ЗначениеЗаполнено(Строение) Тогда
		ЧастныйСектор 				= Истина;
		Запрос.УстановитьПараметр("ЧастныйСектор", 	ЧастныйСектор);
		Запрос.УстановитьПараметр("МКД",			Справочники.энргСтроения.ПустаяСсылка());
		
		Текст 						= СтрЗаменить(Текст,"И (энргОбъемНачислений.Строение = &Строение)","");
		Текст 						= СтрЗаменить(Текст,"И (энргСтабильныеПериоды.Строение = &Строение)","");
		Текст 						= СтрЗаменить(Текст,"И энргСтабильныеПериоды.Строение = &Строение","");
		Текст 						= СтрЗаменить(Текст,"И Строение = &Строение","");
		
		Текст 						= СтрЗаменить(Текст,"И (энргОбъемНачислений.Помещение = &Помещение)","");
		Текст 						= СтрЗаменить(Текст,"И (энргСтабильныеПериоды.Помещение = &Помещение)","");
		Текст 						= СтрЗаменить(Текст,"И энргСтабильныеПериоды.Помещение = &Помещение","");
		Текст 						= СтрЗаменить(Текст,"И Помещение = &Помещение","");
		Текст 						= СтрЗаменить(Текст,"И (МКД = &МКД","И (ЛОЖЬ");
		
		
		
							
		
	ИначеЕсли Не Строение = Неопределено Тогда
		ЧастныйСектор 				= Ложь;
		Запрос.УстановитьПараметр("ЧастныйСектор", 	ЧастныйСектор);
		Запрос.УстановитьПараметр("МКД",			Строение);
		Запрос.УстановитьПараметр("Строение",		Строение);
		
		Текст 						= СтрЗаменить(Текст,"И (энргОбъемНачислений.Помещение = &Помещение)","");
		Текст 						= СтрЗаменить(Текст,"И (энргСтабильныеПериоды.Помещение = &Помещение)","");
		Текст 						= СтрЗаменить(Текст,"И энргСтабильныеПериоды.Помещение = &Помещение","");
		Текст 						= СтрЗаменить(Текст,"И Помещение = &Помещение","");
		
	Иначе
		Текст 						= СтрЗаменить(Текст,"И (энргОбъемНачислений.ЧастныйСектор = &ЧастныйСектор)","");
		Текст 						= СтрЗаменить(Текст,"И (энргСтабильныеПериоды.ЧастныйСектор = &ЧастныйСектор)","");
		Текст 						= СтрЗаменить(Текст,"И энргСтабильныеПериоды.ЧастныйСектор = &ЧастныйСектор","");
		Текст 						= СтрЗаменить(Текст,"И ЧастныйСектор = &ЧастныйСектор","");
		
		Текст 						= СтрЗаменить(Текст,"И (энргОбъемНачислений.Строение = &Строение)","");
		Текст 						= СтрЗаменить(Текст,"И (энргСтабильныеПериоды.Строение = &Строение)","");
		Текст 						= СтрЗаменить(Текст,"И энргСтабильныеПериоды.Строение = &Строение","");
		Текст 						= СтрЗаменить(Текст,"И Строение = &Строение","");
		Текст 						= СтрЗаменить(Текст,"И энргДокументыНачислений.МКД = &МКД","");
		Текст 						= СтрЗаменить(Текст,"И МКД = &МКД","");
		Текст 						= СтрЗаменить(Текст,"И (МКД = &МКД","И (ИСТИНА");
		
		Текст 						= СтрЗаменить(Текст,"И (энргОбъемНачислений.Помещение = &Помещение)","");
		Текст 						= СтрЗаменить(Текст,"И (энргСтабильныеПериоды.Помещение = &Помещение)","");
		Текст 						= СтрЗаменить(Текст,"И энргСтабильныеПериоды.Помещение = &Помещение","");
		Текст 						= СтрЗаменить(Текст,"И Помещение = &Помещение",""); 		
	КонецЕсли;
	Запрос.Текст 					= Текст; 	
	Запрос.МенеджерВременныхТаблиц 	= МВТ;
	Запрос.УстановитьПараметр("Организация", 					Организация);
	Запрос.УстановитьПараметр("ПериодНачисления", 				ПериодНачисления);
	Запрос.УстановитьПараметр("НачалоГода", 					НачалоГода(ПериодНачисления));
	Запрос.УстановитьПараметр("ОкончаниеГода", 					КонецМесяца(ПериодНачисления));
	Запрос.УстановитьПараметр("Район", 							Район);
	Запрос.УстановитьПараметр("ЗавершениеОП", 					ГраницыПериода.ЗавершениеОП);
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура ОбработатьРезультатЗапросаИзменитьПризнакСостояниеПрибора(Результат, Делегат)  
	перем ТекОрганизация, ТекРайон, ТекМКД; 
	
	Ошибки 														= "";
	Выборка 													= Результат.Выбрать();
	
	Пока Выборка.следующий() цикл		 		
		Если НЕ ТекОрганизация = Выборка.Организация
			ИЛИ НЕ ТекМКД = Выборка.МКД Тогда						
			ДокументОбъект  									= Неопределено;			
			Делегат.ПередПроведениемМКД(Выборка.МКД,Выборка.ДокументНачисления, Выборка.ДокументНачисленияПометкаУдаления);
			Набор 												= Делегат.НаборОбъемНачислений;
			//НаборОбъемПомещений 								= Делегат.НаборОбъемНачисленийПомещений;			
		КонецЕсли; 				
		
		СтрокаНабораСнимаем										= Набор.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаНабораСнимаем, Выборка);
		СтрокаНабораСнимаем.Период								= Выборка.ЗавершениеОП-1;		
		СтрокаНабораСнимаем.Сумма 								= -СтрокаНабораСнимаем.Сумма;
		СтрокаНабораСнимаем.ОбъемУслуги 						= -СтрокаНабораСнимаем.ОбъемУслуги;
		СтрокаНабораСнимаем.ОбъемУслугиПотребленный 			= -СтрокаНабораСнимаем.ОбъемУслугиПотребленный;
		СтрокаНабораСнимаем.СуммаПоПовышенномуКоэффициенту 		= -СтрокаНабораСнимаем.СуммаПоПовышенномуКоэффициенту;
		СтрокаНабораСнимаем.ОбъемУслугиСоцНорма 				= -СтрокаНабораСнимаем.ОбъемУслугиСоцНорма;
		СтрокаНабораСнимаем.ОбъемУслугиПотребленныйСоцНорма 	= -СтрокаНабораСнимаем.ОбъемУслугиПотребленныйСоцНорма;
		СтрокаНабораСнимаем.ПериодРасчета 						= Выборка.ПериодРасчета;	
		
		
		СтрокаНабораДобавляем									= Набор.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаНабораДобавляем, Выборка);
		СтрокаНабораДобавляем.БылУстановленныйПриборВЭтомГоду	= НЕ Выборка.БылУстановленныйПриборВЭтомГоду;
		СтрокаНабораДобавляем.Период							= Выборка.ЗавершениеОП-1;
		СтрокаНабораДобавляем.ПериодРасчета 					= Выборка.ПериодРасчета;
		
		ТекОрганизация 											= Выборка.Организация;
		ТекРайон 												= Выборка.Район;
		ТекМКД 													= Выборка.МКД; 		
	КонецЦикла;	
	
	Если Не ТекМКД = Неопределено Тогда
		Делегат.ПослеПроведенияМКД(Ошибки);
	КонецЕсли;
		
	Если Не ПустаяСтрока(Ошибки) Тогда
		ВызватьИсключение Ошибки;
	КонецЕсли;	
	
КонецПроцедуры

#КонецОбласти

#Область СнятьСредниеНачисления_ВспомогательныеПроцедурыИФункции

Процедура ПрочитатьНеСписанныйСредний(МВТ,ПериодНачисления,Организация,Район,ЧастныйСектор,Строение,Помещение,НачалоПериодаРасчета,ТаблицаПриемник = Неопределено)
	Запрос  						= Новый Запрос;
	Запрос.МенеджерВременныхТаблиц 	= МВТ;
	Текст 							=
	"ВЫБРАТЬ
	|	энргДокументыНачислений.ДокументНачисления КАК ДокументНачисления
	|ПОМЕСТИТЬ ДокументыНачислений
	|ИЗ
	|	РегистрСведений.энргДокументыНачислений КАК энргДокументыНачислений
	|ГДЕ
	|	энргДокументыНачислений.Организация = &Организация
	|	И энргДокументыНачислений.ПериодНачисления = &ПериодНачисления
	|	И энргДокументыНачислений.Район = &Район
	|	И энргДокументыНачислений.МКД = &МКД
	|	И энргДокументыНачислений.ВидОперацийНачисления = ЗНАЧЕНИЕ(Перечисление.энргВидыОперацийНачисления.Индивидуальные)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	энргНачисленныйСреднийОбъемОстатки.Организация КАК Организация,
	|	энргНачисленныйСреднийОбъемОстатки.Район КАК Район,
	|	энргНачисленныйСреднийОбъемОстатки.ЧастныйСектор КАК ЧастныйСектор,
	|	энргНачисленныйСреднийОбъемОстатки.Строение КАК Строение,
	|	энргНачисленныйСреднийОбъемОстатки.Помещение КАК Помещение,
	|	энргНачисленныйСреднийОбъемОстатки.Абонент КАК Абонент,
	|	энргНачисленныйСреднийОбъемОстатки.ПериодНачисления КАК ПериодНачисления,
	|	энргНачисленныйСреднийОбъемОстатки.ТочкаУчета КАК ТочкаУчета,
	|	энргНачисленныйСреднийОбъемОстатки.Услуга КАК Услуга,
	|	энргНачисленныйСреднийОбъемОстатки.НаправлениеИспользованияТУ КАК НаправлениеИспользованияТУ,
	|	энргНачисленныйСреднийОбъемОстатки.ЗначениеТарифа КАК ЗначениеТарифа,
	|	энргНачисленныйСреднийОбъемОстатки.ПриборУчета КАК ПриборУчета,
	|	энргНачисленныйСреднийОбъемОстатки.Шкала КАК Шкала,
	|	энргНачисленныйСреднийОбъемОстатки.ТарифнаяЗона КАК ТарифнаяЗона,
	|	энргНачисленныйСреднийОбъемОстатки.Поставщик КАК Поставщик,
	|	энргНачисленныйСреднийОбъемОстатки.ЗависимаяТочкаУчета КАК ЗависимаяТочкаУчета,
	|	энргНачисленныйСреднийОбъемОстатки.ПриборЗависимой КАК ПриборЗависимой,
	|	энргНачисленныйСреднийОбъемОстатки.СпособНачисления КАК СпособНачисления,
	|	энргНачисленныйСреднийОбъемОстатки.СверхНорматива КАК СверхНорматива,
	|	энргНачисленныйСреднийОбъемОстатки.СуммаОстаток КАК Сумма,
	|	энргНачисленныйСреднийОбъемОстатки.ОбъемУслугиОстаток КАК ОбъемУслуги,
	|	энргНачисленныйСреднийОбъемОстатки.ОбъемУслугиПотребленныйОстаток КАК ОбъемУслугиПотребленный,
	|	энргПомещения.Родитель КАК ПомещениеРодитель
	|ПОМЕСТИТЬ НеСписанныйСредний
	|ИЗ
	|	РегистрНакопления.энргНачисленныйСреднийОбъем.Остатки(
	|			&НачалоПериодаРасчетаГраница,
	|			Организация = &Организация
	|				И Район = &Район
	|				И ЧастныйСектор = &ЧастныйСектор
	|				И Строение = &Строение
	|				И Помещение = &Помещение) КАК энргНачисленныйСреднийОбъемОстатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.энргПомещения КАК энргПомещения
	|		ПО энргНачисленныйСреднийОбъемОстатки.Помещение = энргПомещения.Ссылка";
	
	Если ЧастныйСектор = Неопределено Тогда
		Текст 		= СтрЗаменить(Текст,"И ЧастныйСектор = &ЧастныйСектор","");
		Текст 		= СтрЗаменить(Текст,"И Строение = &Строение","");		
		Текст 		= СтрЗаменить(Текст,"И Помещение = &Помещение","");
		Текст 		= СтрЗаменить(Текст,"И энргДокументыНачислений.МКД = &МКД","");
	ИначеЕсли Не ЗначениеЗаполнено(Строение) Тогда
		Текст 		= СтрЗаменить(Текст,"И Строение = &Строение","");		
		Текст 		= СтрЗаменить(Текст,"И Помещение = &Помещение","");
		
		Запрос.УстановитьПараметр("ЧастныйСектор",		ЧастныйСектор);
		
		Если ЧастныйСектор Тогда
			Запрос.УстановитьПараметр("МКД",				Справочники.энргСтроения.ПустаяСсылка());
		Иначе
			Текст 		= СтрЗаменить(Текст,"И энргДокументыНачислений.МКД = &МКД","");
		КонецЕсли;
	ИначеЕсли ЗначениеЗаполнено(Помещение) Тогда
		Если ЧастныйСектор Тогда
			Запрос.УстановитьПараметр("МКД",			Справочники.энргСтроения.ПустаяСсылка());
		Иначе
			Запрос.УстановитьПараметр("МКД",			Строение);
		КонецЕсли;
		Запрос.УстановитьПараметр("ЧастныйСектор",		ЧастныйСектор);
		Запрос.УстановитьПараметр("Строение",			Строение);
		Запрос.УстановитьПараметр("Помещение",			Помещение)
	Иначе 	
		Текст 		= СтрЗаменить(Текст,"И Помещение = &Помещение","");
		Если ЧастныйСектор Тогда
			Запрос.УстановитьПараметр("МКД",			Справочники.энргСтроения.ПустаяСсылка());
		Иначе
			Запрос.УстановитьПараметр("МКД",			Строение);
		КонецЕсли;
		Запрос.УстановитьПараметр("ЧастныйСектор",		ЧастныйСектор);
		Запрос.УстановитьПараметр("Строение",			Строение);
	КонецЕсли;
			
	Запрос.УстановитьПараметр("НачалоПериодаРасчетаГраница",Новый Граница(НачалоПериодаРасчета,ВидГраницы.Исключая));
	Запрос.УстановитьПараметр("ПериодНачисления",				ПериодНачисления);
	Запрос.УстановитьПараметр("Район",							Район);
	Запрос.УстановитьПараметр("Организация",					Организация);
	Запрос.Текст 			= Текст;
	
	Если ТаблицаПриемник = Неопределено тогда
		Запрос.Выполнить();
	иначе
		Запрос.Текст 		= СтрЗаменить(Запрос.Текст,"ПОМЕСТИТЬ НеСписанныйСредний","");
		Результат  			= Запрос.Выполнить();
		Выборка 			= Результат.Выбрать();
		Пока Выборка.Следующий() цикл
			ЗаполнитьЗначенияСвойств(ТаблицаПриемник.добавить(),Выборка);
		КонецЦикла;  		 
	КонецЕсли; 
	
КонецПроцедуры

Функция РезультатЗапросаПерерасчетСреднего(МВТ,Организация,ПериодНачисления,КонецПериодаРасчета,Район,ЧастныйСектор,Строение,Помещение,НачисленныйСреднийОбъем=Неопределено)
	ТекстРазделить 						= " 
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|";  
	
	Текст 	= "";
	Если НачисленныйСреднийОбъем <> Неопределено тогда
		Текст 	="ВЫБРАТЬ
		|	НеСписанныйСредний.Организация,
		|	НеСписанныйСредний.Район,
		|	НеСписанныйСредний.МКД,
		|	НеСписанныйСредний.Абонент,
		|	НеСписанныйСредний.ПериодНачисления,
		|	НеСписанныйСредний.ТочкаУчета,
		|	НеСписанныйСредний.Услуга,
		|	НеСписанныйСредний.ЗначениеТарифа,
		|	НеСписанныйСредний.ПриборУчета,
		|	НеСписанныйСредний.Сумма,
		|	НеСписанныйСредний.ОбъемУслуги,
		|	НеСписанныйСредний.ОбъемУслугиПотребленный,
		|	НеСписанныйСредний.Поставщик,
		|	НеСписанныйСредний.ЗависимаяТочкаУчета КАК ЗависимаяТочкаУчета,
		|	НеСписанныйСредний.ПриборЗависимой КАК ПриборЗависимой
		|ПОМЕСТИТЬ НеСписанныйСреднийБезГруппировки
		|ИЗ
		|	&НачисленныйСреднийОбъем КАК НеСписанныйСредний
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	НеСписанныйСреднийБезГруппировки.Организация,
		|	НеСписанныйСреднийБезГруппировки.Район,
		|	НеСписанныйСреднийБезГруппировки.МКД,
		|	НеСписанныйСреднийБезГруппировки.Абонент,
		|	НеСписанныйСреднийБезГруппировки.ПериодНачисления,
		|	НеСписанныйСреднийБезГруппировки.ТочкаУчета,
		|	НеСписанныйСреднийБезГруппировки.Услуга,
		|	НеСписанныйСреднийБезГруппировки.ЗначениеТарифа,
		|	НеСписанныйСреднийБезГруппировки.ПриборУчета,
		|	СУММА(НеСписанныйСреднийБезГруппировки.Сумма) КАК Сумма,
		|	СУММА(НеСписанныйСреднийБезГруппировки.ОбъемУслуги) КАК ОбъемУслуги,
		|	СУММА(НеСписанныйСреднийБезГруппировки.ОбъемУслугиПотребленный) КАК ОбъемУслугиПотребленный,
		|	НеСписанныйСреднийБезГруппировки.Поставщик,
		|	НеСписанныйСреднийБезГруппировки.ЗависимаяТочкаУчета КАК ЗависимаяТочкаУчета,
		|	НеСписанныйСреднийБезГруппировки.ПриборЗависимой КАК ПриборЗависимой
		|ПОМЕСТИТЬ НеСписанныйСредний
		|ИЗ
		|	НеСписанныйСреднийБезГруппировки КАК НеСписанныйСреднийБезГруппировки
		|
		|СГРУППИРОВАТЬ ПО
		|	НеСписанныйСреднийБезГруппировки.Организация,
		|	НеСписанныйСреднийБезГруппировки.Район,
		|	НеСписанныйСреднийБезГруппировки.МКД,
		|	НеСписанныйСреднийБезГруппировки.Абонент,
		|	НеСписанныйСреднийБезГруппировки.ПериодНачисления,
		|	НеСписанныйСреднийБезГруппировки.ТочкаУчета,
		|	НеСписанныйСреднийБезГруппировки.Услуга,
		|	НеСписанныйСреднийБезГруппировки.ЗначениеТарифа,
		|	НеСписанныйСреднийБезГруппировки.ПриборУчета,
		|	НеСписанныйСреднийБезГруппировки.Поставщик,
		|	НеСписанныйСреднийБезГруппировки.ЗависимаяТочкаУчета,
		|	НеСписанныйСреднийБезГруппировки.ПриборЗависимой";
		
		Текст 		= Текст + ТекстРазделить;
	КонецЕсли;  
	
	Текст 			= Текст + 
	"ВЫБРАТЬ
	|	НеСписанныйСредний.Организация КАК Организация,
	|	НеСписанныйСредний.Район КАК Район,
	|	НеСписанныйСредний.ЧастныйСектор КАК ЧастныйСектор,
	|	НеСписанныйСредний.Строение КАК Строение,
	|	НеСписанныйСредний.Помещение КАК Помещение,
	|	НеСписанныйСредний.ПериодНачисления КАК ПериодНачисления,
	|	НеСписанныйСредний.ТочкаУчета КАК ТочкаУчета,
	|	НеСписанныйСредний.Услуга КАК Услуга,
	|	НеСписанныйСредний.НаправлениеИспользованияТУ КАК НаправлениеИспользованияТУ,
	|	НеСписанныйСредний.ЗначениеТарифа КАК ЗначениеТарифа,
	|	НеСписанныйСредний.ПриборУчета КАК ПриборУчета,
	|	НеСписанныйСредний.Шкала КАК Шкала,
	|	НеСписанныйСредний.ТарифнаяЗона КАК ТарифнаяЗона,
	|	НеСписанныйСредний.Абонент КАК Абонент,
	|	НеСписанныйСредний.Сумма КАК Сумма,
	|	НеСписанныйСредний.ОбъемУслуги КАК ОбъемУслуги,
	|	НеСписанныйСредний.ОбъемУслугиПотребленный КАК ОбъемУслугиПотребленный,
	|	МИНИМУМ(энргПредоставленныеПоказания.ДатаРегистратора) КАК ДатаРегистратора,
	|	НеСписанныйСредний.Поставщик КАК Поставщик,
	|	НеСписанныйСредний.ЗависимаяТочкаУчета КАК ЗависимаяТочкаУчета,
	|	НеСписанныйСредний.ПриборЗависимой КАК ПриборЗависимой,
	|	НеСписанныйСредний.СпособНачисления КАК СпособНачисления,
	|	НеСписанныйСредний.СверхНорматива КАК СверхНорматива,
	|	НеСписанныйСредний.ПомещениеРодитель КАК ПомещениеРодитель
	|ПОМЕСТИТЬ ДанныеДляСписанияМинДата
	|ИЗ
	|	РегистрСведений.энргПредоставленныеПоказания КАК энргПредоставленныеПоказания
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ НеСписанныйСредний КАК НеСписанныйСредний
	|		ПО энргПредоставленныеПоказания.Организация = НеСписанныйСредний.Организация
	|			И энргПредоставленныеПоказания.Район = НеСписанныйСредний.Район
	|			И энргПредоставленныеПоказания.ЧастныйСектор = НеСписанныйСредний.ЧастныйСектор
	|			И энргПредоставленныеПоказания.Строение = НеСписанныйСредний.Строение
	|			И энргПредоставленныеПоказания.Помещение = НеСписанныйСредний.Помещение
	|			И энргПредоставленныеПоказания.ПриборУчета = НеСписанныйСредний.ПриборУчета
	|			И энргПредоставленныеПоказания.Шкала = НеСписанныйСредний.Шкала
	|			И (энргПредоставленныеПоказания.Организация = &Организация)
	|			И (энргПредоставленныеПоказания.ПериодНачисления = &ПериодНачисления)
	|			И (энргПредоставленныеПоказания.Район = &Район)
	|			И (энргПредоставленныеПоказания.ЧастныйСектор = &ЧастныйСектор)
	|			И (энргПредоставленныеПоказания.Строение = &Строение)
	|			И (энргПредоставленныеПоказания.Помещение = &Помещение)
	|			И (энргПредоставленныеПоказания.ПоказанияТекущегоПериода)
	|
	|СГРУППИРОВАТЬ ПО
	|	НеСписанныйСредний.Организация,
	|	НеСписанныйСредний.Район,
	|	НеСписанныйСредний.ЧастныйСектор,
	|	НеСписанныйСредний.Строение,
	|	НеСписанныйСредний.Помещение,
	|	НеСписанныйСредний.ПериодНачисления,
	|	НеСписанныйСредний.ТочкаУчета,
	|	НеСписанныйСредний.Услуга,
	|	НеСписанныйСредний.НаправлениеИспользованияТУ,
	|	НеСписанныйСредний.ЗначениеТарифа,
	|	НеСписанныйСредний.ПриборУчета,
	|	НеСписанныйСредний.Шкала,
	|	НеСписанныйСредний.ТарифнаяЗона,
	|	НеСписанныйСредний.Абонент,
	|	НеСписанныйСредний.Сумма,
	|	НеСписанныйСредний.ОбъемУслуги,
	|	НеСписанныйСредний.ОбъемУслугиПотребленный,
	|	НеСписанныйСредний.Поставщик,
	|	НеСписанныйСредний.ЗависимаяТочкаУчета,
	|	НеСписанныйСредний.ПриборЗависимой,
	|	НеСписанныйСредний.СпособНачисления,
	|	НеСписанныйСредний.СверхНорматива,
	|	НеСписанныйСредний.ПомещениеРодитель
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НеСписанныйСредний.Организация,
	|	НеСписанныйСредний.Район,
	|	НеСписанныйСредний.ЧастныйСектор,
	|	НеСписанныйСредний.Строение,
	|	НеСписанныйСредний.Помещение,
	|	НеСписанныйСредний.ПериодНачисления,
	|	НеСписанныйСредний.ТочкаУчета,
	|	НеСписанныйСредний.Услуга,
	|	НеСписанныйСредний.НаправлениеИспользованияТУ,
	|	НеСписанныйСредний.ЗначениеТарифа,
	|	НеСписанныйСредний.ПриборУчета,
	|	НеСписанныйСредний.Шкала,
	|	НеСписанныйСредний.ТарифнаяЗона,
	|	НеСписанныйСредний.Абонент,
	|	НеСписанныйСредний.Сумма,
	|	НеСписанныйСредний.ОбъемУслуги,
	|	НеСписанныйСредний.ОбъемУслугиПотребленный,
	|	МИНИМУМ(энргПредоставленныеПоказания.ДатаРегистратора),
	|	НеСписанныйСредний.Поставщик,
	|	НеСписанныйСредний.ЗависимаяТочкаУчета,
	|	НеСписанныйСредний.ПриборЗависимой,
	|	НеСписанныйСредний.СпособНачисления,
	|	НеСписанныйСредний.СверхНорматива,
	|	НеСписанныйСредний.ПомещениеРодитель
	|ИЗ
	|	РегистрСведений.энргПредоставленныеПоказания КАК энргПредоставленныеПоказания
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ НеСписанныйСредний КАК НеСписанныйСредний
	|		ПО энргПредоставленныеПоказания.Организация = НеСписанныйСредний.Организация
	|			И энргПредоставленныеПоказания.Район = НеСписанныйСредний.Район
	|			И энргПредоставленныеПоказания.ЧастныйСектор = НеСписанныйСредний.ЧастныйСектор
	|			И энргПредоставленныеПоказания.Строение = НеСписанныйСредний.Строение
	|			И энргПредоставленныеПоказания.Помещение = НеСписанныйСредний.ПомещениеРодитель
	|			И энргПредоставленныеПоказания.ПриборУчета = НеСписанныйСредний.ПриборУчета
	|			И энргПредоставленныеПоказания.Шкала = НеСписанныйСредний.Шкала
	|			И (энргПредоставленныеПоказания.Организация = &Организация)
	|			И (энргПредоставленныеПоказания.ПериодНачисления = &ПериодНачисления)
	|			И (энргПредоставленныеПоказания.Район = &Район)
	|			И (энргПредоставленныеПоказания.ЧастныйСектор = &ЧастныйСектор)
	|			И (энргПредоставленныеПоказания.Строение = &Строение)
	|			И (энргПредоставленныеПоказания.Помещение = &Помещение)
	|			И (энргПредоставленныеПоказания.ПоказанияТекущегоПериода)
	|
	|СГРУППИРОВАТЬ ПО
	|	НеСписанныйСредний.Организация,
	|	НеСписанныйСредний.Район,
	|	НеСписанныйСредний.ЧастныйСектор,
	|	НеСписанныйСредний.Строение,
	|	НеСписанныйСредний.Помещение,
	|	НеСписанныйСредний.ПериодНачисления,
	|	НеСписанныйСредний.ТочкаУчета,
	|	НеСписанныйСредний.Услуга,
	|	НеСписанныйСредний.НаправлениеИспользованияТУ,
	|	НеСписанныйСредний.ЗначениеТарифа,
	|	НеСписанныйСредний.ПриборУчета,
	|	НеСписанныйСредний.Шкала,
	|	НеСписанныйСредний.ТарифнаяЗона,
	|	НеСписанныйСредний.Абонент,
	|	НеСписанныйСредний.Сумма,
	|	НеСписанныйСредний.ОбъемУслуги,
	|	НеСписанныйСредний.ОбъемУслугиПотребленный,
	|	НеСписанныйСредний.Поставщик,
	|	НеСписанныйСредний.ЗависимаяТочкаУчета,
	|	НеСписанныйСредний.ПриборЗависимой,
	|	НеСписанныйСредний.СпособНачисления,
	|	НеСписанныйСредний.СверхНорматива,
	|	НеСписанныйСредний.ПомещениеРодитель
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДанныеДляСписанияМинДата.Организация КАК Организация,
	|	ДанныеДляСписанияМинДата.Район КАК Район,
	|	ДанныеДляСписанияМинДата.ЧастныйСектор КАК ЧастныйСектор,
	|	ДанныеДляСписанияМинДата.Строение КАК Строение,
	|	ДанныеДляСписанияМинДата.Помещение КАК Помещение,
	|	ДанныеДляСписанияМинДата.ПериодНачисления КАК ПериодНачисления,
	|	ДанныеДляСписанияМинДата.ТочкаУчета КАК ТочкаУчета,
	|	ДанныеДляСписанияМинДата.Услуга КАК Услуга,
	|	ДанныеДляСписанияМинДата.НаправлениеИспользованияТУ КАК НаправлениеИспользованияТУ,
	|	ДанныеДляСписанияМинДата.ЗначениеТарифа КАК ЗначениеТарифа,
	|	ДанныеДляСписанияМинДата.ПриборУчета КАК ПриборУчета,
	|	ДанныеДляСписанияМинДата.Шкала КАК Шкала,
	|	ДанныеДляСписанияМинДата.ТарифнаяЗона КАК ТарифнаяЗона,
	|	ДанныеДляСписанияМинДата.Сумма КАК Сумма,
	|	ДанныеДляСписанияМинДата.ОбъемУслуги КАК ОбъемУслуги,
	|	ДанныеДляСписанияМинДата.ОбъемУслугиПотребленный КАК ОбъемУслугиПотребленный,
	|	ДанныеДляСписанияМинДата.ДатаРегистратора КАК ДатаРегистратора,
	|	МИНИМУМ(энргПредоставленныеПоказания.ДокРегистратор) КАК ДокРегистратор,
	|	ДанныеДляСписанияМинДата.Поставщик КАК Поставщик,
	|	ДанныеДляСписанияМинДата.ЗависимаяТочкаУчета КАК ЗависимаяТочкаУчета,
	|	ДанныеДляСписанияМинДата.ПриборЗависимой КАК ПриборЗависимой,
	|	ДанныеДляСписанияМинДата.СпособНачисления КАК СпособНачисления,
	|	ДанныеДляСписанияМинДата.Абонент КАК Абонент,
	|	ДанныеДляСписанияМинДата.СверхНорматива КАК СверхНорматива,
	|	ДанныеДляСписанияМинДата.ПомещениеРодитель КАК ПомещениеРодитель
	|ПОМЕСТИТЬ ДанныеДляСписанияМинРегистратор
	|ИЗ
	|	ДанныеДляСписанияМинДата КАК ДанныеДляСписанияМинДата
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.энргПредоставленныеПоказания КАК энргПредоставленныеПоказания
	|		ПО ДанныеДляСписанияМинДата.Организация = энргПредоставленныеПоказания.Организация
	|			И ДанныеДляСписанияМинДата.Район = энргПредоставленныеПоказания.Район
	|			И ДанныеДляСписанияМинДата.ЧастныйСектор = энргПредоставленныеПоказания.ЧастныйСектор
	|			И ДанныеДляСписанияМинДата.Строение = энргПредоставленныеПоказания.Строение
	|			И ДанныеДляСписанияМинДата.Помещение = энргПредоставленныеПоказания.Помещение
	|			И ДанныеДляСписанияМинДата.ПриборУчета = энргПредоставленныеПоказания.ПриборУчета
	|			И ДанныеДляСписанияМинДата.Шкала = энргПредоставленныеПоказания.Шкала
	|			И ДанныеДляСписанияМинДата.ДатаРегистратора = энргПредоставленныеПоказания.ДатаРегистратора
	|			И (энргПредоставленныеПоказания.Организация = &Организация)
	|			И (энргПредоставленныеПоказания.ПериодНачисления = &ПериодНачисления)
	|			И (энргПредоставленныеПоказания.Район = &Район)
	|			И (энргПредоставленныеПоказания.ЧастныйСектор = &ЧастныйСектор)
	|			И (энргПредоставленныеПоказания.Строение = &Строение)
	|			И (энргПредоставленныеПоказания.Помещение = &Помещение)
	|			И (энргПредоставленныеПоказания.ПоказанияТекущегоПериода)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДанныеДляСписанияМинДата.Организация,
	|	ДанныеДляСписанияМинДата.Район,
	|	ДанныеДляСписанияМинДата.ЧастныйСектор,
	|	ДанныеДляСписанияМинДата.Строение,
	|	ДанныеДляСписанияМинДата.Помещение,
	|	ДанныеДляСписанияМинДата.ПериодНачисления,
	|	ДанныеДляСписанияМинДата.ТочкаУчета,
	|	ДанныеДляСписанияМинДата.Услуга,
	|	ДанныеДляСписанияМинДата.НаправлениеИспользованияТУ,
	|	ДанныеДляСписанияМинДата.ЗначениеТарифа,
	|	ДанныеДляСписанияМинДата.ПриборУчета,
	|	ДанныеДляСписанияМинДата.Шкала,
	|	ДанныеДляСписанияМинДата.ТарифнаяЗона,
	|	ДанныеДляСписанияМинДата.Сумма,
	|	ДанныеДляСписанияМинДата.ОбъемУслуги,
	|	ДанныеДляСписанияМинДата.ОбъемУслугиПотребленный,
	|	ДанныеДляСписанияМинДата.ДатаРегистратора,
	|	ДанныеДляСписанияМинДата.Поставщик,
	|	ДанныеДляСписанияМинДата.ЗависимаяТочкаУчета,
	|	ДанныеДляСписанияМинДата.ПриборЗависимой,
	|	ДанныеДляСписанияМинДата.СпособНачисления,
	|	ДанныеДляСписанияМинДата.Абонент,
	|	ДанныеДляСписанияМинДата.СверхНорматива,
	|	ДанныеДляСписанияМинДата.ПомещениеРодитель
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДанныеДляСписанияМинДата.Организация,
	|	ДанныеДляСписанияМинДата.Район,
	|	ДанныеДляСписанияМинДата.ЧастныйСектор,
	|	ДанныеДляСписанияМинДата.Строение,
	|	ДанныеДляСписанияМинДата.Помещение,
	|	ДанныеДляСписанияМинДата.ПериодНачисления,
	|	ДанныеДляСписанияМинДата.ТочкаУчета,
	|	ДанныеДляСписанияМинДата.Услуга,
	|	ДанныеДляСписанияМинДата.НаправлениеИспользованияТУ,
	|	ДанныеДляСписанияМинДата.ЗначениеТарифа,
	|	ДанныеДляСписанияМинДата.ПриборУчета,
	|	ДанныеДляСписанияМинДата.Шкала,
	|	ДанныеДляСписанияМинДата.ТарифнаяЗона,
	|	ДанныеДляСписанияМинДата.Сумма,
	|	ДанныеДляСписанияМинДата.ОбъемУслуги,
	|	ДанныеДляСписанияМинДата.ОбъемУслугиПотребленный,
	|	ДанныеДляСписанияМинДата.ДатаРегистратора,
	|	МИНИМУМ(энргПредоставленныеПоказания.ДокРегистратор),
	|	ДанныеДляСписанияМинДата.Поставщик,
	|	ДанныеДляСписанияМинДата.ЗависимаяТочкаУчета,
	|	ДанныеДляСписанияМинДата.ПриборЗависимой,
	|	ДанныеДляСписанияМинДата.СпособНачисления,
	|	ДанныеДляСписанияМинДата.Абонент,
	|	ДанныеДляСписанияМинДата.СверхНорматива,
	|	ДанныеДляСписанияМинДата.ПомещениеРодитель
	|ИЗ
	|	ДанныеДляСписанияМинДата КАК ДанныеДляСписанияМинДата
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.энргПредоставленныеПоказания КАК энргПредоставленныеПоказания
	|		ПО ДанныеДляСписанияМинДата.Организация = энргПредоставленныеПоказания.Организация
	|			И ДанныеДляСписанияМинДата.Район = энргПредоставленныеПоказания.Район
	|			И ДанныеДляСписанияМинДата.ЧастныйСектор = энргПредоставленныеПоказания.ЧастныйСектор
	|			И ДанныеДляСписанияМинДата.Строение = энргПредоставленныеПоказания.Строение
	|			И ДанныеДляСписанияМинДата.ПомещениеРодитель = энргПредоставленныеПоказания.Помещение
	|			И ДанныеДляСписанияМинДата.ПриборУчета = энргПредоставленныеПоказания.ПриборУчета
	|			И ДанныеДляСписанияМинДата.Шкала = энргПредоставленныеПоказания.Шкала
	|			И ДанныеДляСписанияМинДата.ДатаРегистратора = энргПредоставленныеПоказания.ДатаРегистратора
	|			И (энргПредоставленныеПоказания.Организация = &Организация)
	|			И (энргПредоставленныеПоказания.ПериодНачисления = &ПериодНачисления)
	|			И (энргПредоставленныеПоказания.Район = &Район)
	|			И (энргПредоставленныеПоказания.ЧастныйСектор = &ЧастныйСектор)
	|			И (энргПредоставленныеПоказания.Строение = &Строение)
	|			И (энргПредоставленныеПоказания.Помещение = &Помещение)
	|			И (энргПредоставленныеПоказания.ПоказанияТекущегоПериода)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДанныеДляСписанияМинДата.Организация,
	|	ДанныеДляСписанияМинДата.Район,
	|	ДанныеДляСписанияМинДата.ЧастныйСектор,
	|	ДанныеДляСписанияМинДата.Строение,
	|	ДанныеДляСписанияМинДата.Помещение,
	|	ДанныеДляСписанияМинДата.ПериодНачисления,
	|	ДанныеДляСписанияМинДата.ТочкаУчета,
	|	ДанныеДляСписанияМинДата.Услуга,
	|	ДанныеДляСписанияМинДата.НаправлениеИспользованияТУ,
	|	ДанныеДляСписанияМинДата.ЗначениеТарифа,
	|	ДанныеДляСписанияМинДата.ПриборУчета,
	|	ДанныеДляСписанияМинДата.Шкала,
	|	ДанныеДляСписанияМинДата.ТарифнаяЗона,
	|	ДанныеДляСписанияМинДата.Сумма,
	|	ДанныеДляСписанияМинДата.ОбъемУслуги,
	|	ДанныеДляСписанияМинДата.ОбъемУслугиПотребленный,
	|	ДанныеДляСписанияМинДата.ДатаРегистратора,
	|	ДанныеДляСписанияМинДата.Поставщик,
	|	ДанныеДляСписанияМинДата.ЗависимаяТочкаУчета,
	|	ДанныеДляСписанияМинДата.ПриборЗависимой,
	|	ДанныеДляСписанияМинДата.СпособНачисления,
	|	ДанныеДляСписанияМинДата.Абонент,
	|	ДанныеДляСписанияМинДата.СверхНорматива,
	|	ДанныеДляСписанияМинДата.ПомещениеРодитель
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	энргОбъемНачислений.Организация КАК Организация,
	|	энргОбъемНачислений.Район КАК Район,
	|	энргОбъемНачислений.Строение КАК Строение,
	|	энргОбъемНачислений.Помещение КАК Помещение,
	|	энргОбъемНачислений.Абонент КАК Абонент,
	|	энргОбъемНачислений.Услуга КАК Услуга,
	|	энргОбъемНачислений.ТочкаУчета КАК ТочкаУчета,
	|	энргОбъемНачислений.Шкала КАК Шкала,
	|	энргОбъемНачислений.ТарифнаяЗона КАК ТарифнаяЗона,
	|	СУММА(энргОбъемНачислений.Сумма) КАК СуммаОборот,
	|	СУММА(энргОбъемНачислений.ОбъемУслуги) КАК ОбъемУслугиОборот,
	|	СУММА(энргОбъемНачислений.ОбъемУслугиПотребленный) КАК ОбъемУслугиПотребленныйОборот,
	|	МАКСИМУМ(энргОбъемНачислений.СниматьНачисленныйСреднийЗависимыхТочек) КАК СниматьНачисленныйСреднийЗависимыхТочек,
	|	МАКСИМУМ(энргОбъемНачислений.СниматьНачисленныйСреднийПоФормулам) КАК СниматьНачисленныйСреднийПоФормулам,
	|	МАКСИМУМ(энргОбъемНачислений.ЕстьСреднийПоВсемТочкамУслуги) КАК ЕстьСреднийПоВсемТочкамУслуги,
	|	энргОбъемНачислений.ЧастныйСектор КАК ЧастныйСектор,
	|	МАКСИМУМ(энргОбъемНачислений.ЗначениеТарифа) КАК ЗначениеТарифа
	|ПОМЕСТИТЬ НачисленныйОбъем
	|ИЗ
	|	ДокументыНачислений КАК ДокументыНачислений
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.энргОбъемНачислений КАК энргОбъемНачислений
	|		ПО (энргОбъемНачислений.Период = &КонецПериода)
	|			И ДокументыНачислений.ДокументНачисления = энргОбъемНачислений.Регистратор
	|
	|СГРУППИРОВАТЬ ПО
	|	энргОбъемНачислений.Организация,
	|	энргОбъемНачислений.Район,
	|	энргОбъемНачислений.Строение,
	|	энргОбъемНачислений.Помещение,
	|	энргОбъемНачислений.Абонент,
	|	энргОбъемНачислений.Услуга,
	|	энргОбъемНачислений.ТочкаУчета,
	|	энргОбъемНачислений.Шкала,
	|	энргОбъемНачислений.ТарифнаяЗона,
	|	энргОбъемНачислений.ЧастныйСектор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВложенныйЗапрос.Организация КАК Организация,
	|	ВложенныйЗапрос.Район КАК Район,
	|	ВложенныйЗапрос.МКД КАК МКД,
	|	ВложенныйЗапрос.ЧастныйСектор КАК ЧастныйСектор,
	|	ВложенныйЗапрос.Строение КАК Строение,
	|	ВложенныйЗапрос.Помещение КАК Помещение,
	|	ВложенныйЗапрос.ПериодНачисления КАК ПериодНачисления,
	|	ВложенныйЗапрос.ТочкаУчета КАК ТочкаУчета,
	|	ВложенныйЗапрос.Услуга КАК Услуга,
	|	ВложенныйЗапрос.НаправлениеИспользованияТУ КАК НаправлениеИспользованияТУ,
	|	ВложенныйЗапрос.ЗначениеТарифа КАК ЗначениеТарифа,
	|	ВложенныйЗапрос.ПриборУчета КАК ПриборУчета,
	|	ВложенныйЗапрос.Шкала КАК Шкала,
	|	ВложенныйЗапрос.ТарифнаяЗона КАК ТарифнаяЗона,
	|	ВложенныйЗапрос.Сумма КАК Сумма,
	|	ВложенныйЗапрос.ОбъемУслуги КАК ОбъемУслуги,
	|	ВложенныйЗапрос.ОбъемУслугиПотребленный КАК ОбъемУслугиПотребленный,
	|	ВложенныйЗапрос.ДокументОснование КАК ДокументОснование,
	|	ВложенныйЗапрос.Поставщик КАК Поставщик,
	|	ВложенныйЗапрос.ДатаДокументаОснования КАК ДатаДокументаОснования,
	|	ВложенныйЗапрос.ЗависимаяТочкаУчета КАК ЗависимаяТочкаУчета,
	|	ВложенныйЗапрос.ПриборЗависимой КАК ПриборЗависимой,
	|	ВложенныйЗапрос.СпособНачисления КАК СпособНачисления,
	|	ВложенныйЗапрос.Абонент КАК Абонент,
	|	ВложенныйЗапрос.СверхНорматива КАК СверхНорматива,
	|	ЕСТЬNULL(энргПерерасчет.Ссылка, ЗНАЧЕНИЕ(Документ.энргПерерасчет.Пустаяссылка)) КАК ДокументПерерасчета,
	|	ЕСТЬNULL(энргПерерасчет.ПометкаУдаления, ЛОЖЬ) КАК ДокументПерерасчетаПометкаУдаления
	|ИЗ
	|	(ВЫБРАТЬ
	|		ДанныеДляСписанияМинРегистратор.Организация КАК Организация,
	|		ДанныеДляСписанияМинРегистратор.Район КАК Район,
	|		ВЫБОР
	|			КОГДА ДанныеДляСписанияМинРегистратор.ЧастныйСектор
	|				ТОГДА ЗНАЧЕНИЕ(Справочник.энргСтроения.ПустаяСсылка)
	|			ИНАЧЕ ДанныеДляСписанияМинРегистратор.Строение
	|		КОНЕЦ КАК МКД,
	|		ДанныеДляСписанияМинРегистратор.ЧастныйСектор КАК ЧастныйСектор,
	|		ДанныеДляСписанияМинРегистратор.Строение КАК Строение,
	|		ДанныеДляСписанияМинРегистратор.Помещение КАК Помещение,
	|		ДанныеДляСписанияМинРегистратор.ПериодНачисления КАК ПериодНачисления,
	|		ДанныеДляСписанияМинРегистратор.ТочкаУчета КАК ТочкаУчета,
	|		ДанныеДляСписанияМинРегистратор.Услуга КАК Услуга,
	|		ДанныеДляСписанияМинРегистратор.НаправлениеИспользованияТУ КАК НаправлениеИспользованияТУ,
	|		ДанныеДляСписанияМинРегистратор.ЗначениеТарифа КАК ЗначениеТарифа,
	|		ДанныеДляСписанияМинРегистратор.ПриборУчета КАК ПриборУчета,
	|		ДанныеДляСписанияМинРегистратор.Шкала КАК Шкала,
	|		ДанныеДляСписанияМинРегистратор.ТарифнаяЗона КАК ТарифнаяЗона,
	|		ДанныеДляСписанияМинРегистратор.Сумма КАК Сумма,
	|		ДанныеДляСписанияМинРегистратор.ОбъемУслуги КАК ОбъемУслуги,
	|		ДанныеДляСписанияМинРегистратор.ОбъемУслугиПотребленный КАК ОбъемУслугиПотребленный,
	|		ДанныеДляСписанияМинРегистратор.ДокРегистратор КАК ДокументОснование,
	|		ДанныеДляСписанияМинРегистратор.Поставщик КАК Поставщик,
	|		ДанныеДляСписанияМинРегистратор.ДатаРегистратора КАК ДатаДокументаОснования,
	|		ДанныеДляСписанияМинРегистратор.ЗависимаяТочкаУчета КАК ЗависимаяТочкаУчета,
	|		ДанныеДляСписанияМинРегистратор.ПриборЗависимой КАК ПриборЗависимой,
	|		ДанныеДляСписанияМинРегистратор.СпособНачисления КАК СпособНачисления,
	|		ДанныеДляСписанияМинРегистратор.Абонент КАК Абонент,
	|		ДанныеДляСписанияМинРегистратор.СверхНорматива КАК СверхНорматива
	|	ИЗ
	|		ДанныеДляСписанияМинРегистратор КАК ДанныеДляСписанияМинРегистратор
	|	ГДЕ
	|		(ДанныеДляСписанияМинРегистратор.Организация, ДанныеДляСписанияМинРегистратор.Район, ДанныеДляСписанияМинРегистратор.Строение, ДанныеДляСписанияМинРегистратор.Помещение, ДанныеДляСписанияМинРегистратор.ЧастныйСектор, ДанныеДляСписанияМинРегистратор.ТочкаУчета, ДанныеДляСписанияМинРегистратор.Услуга, ДанныеДляСписанияМинРегистратор.Шкала, ДанныеДляСписанияМинРегистратор.Абонент) В
	|				(ВЫБРАТЬ
	|					НачисленныйОбъем.Организация,
	|					НачисленныйОбъем.Район,
	|					НачисленныйОбъем.Строение,
	|					НачисленныйОбъем.Помещение,
	|					НачисленныйОбъем.ЧастныйСектор,
	|					НачисленныйОбъем.ТочкаУчета,
	|					НачисленныйОбъем.Услуга,
	|					НачисленныйОбъем.Шкала,
	|					НачисленныйОбъем.Абонент
	|				ИЗ
	|					НачисленныйОбъем КАК НачисленныйОбъем)
	|		И НЕ ДанныеДляСписанияМинРегистратор.СпособНачисления = ЗНАЧЕНИЕ(ПЕРЕЧИСЛЕНИЕ.энргСпособНачислений.ПоПриборам)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НеСписанныйСредний.Организация,
	|		НеСписанныйСредний.Район,
	|		ВЫБОР
	|			КОГДА НеСписанныйСредний.ЧастныйСектор
	|				ТОГДА ЗНАЧЕНИЕ(Справочник.энргСтроения.ПустаяСсылка)
	|			ИНАЧЕ НеСписанныйСредний.Строение
	|		КОНЕЦ,
	|		НеСписанныйСредний.ЧастныйСектор,
	|		НеСписанныйСредний.Строение,
	|		НеСписанныйСредний.Помещение,
	|		НеСписанныйСредний.ПериодНачисления,
	|		НеСписанныйСредний.ТочкаУчета,
	|		НеСписанныйСредний.Услуга,
	|		НеСписанныйСредний.НаправлениеИспользованияТУ,
	|		НеСписанныйСредний.ЗначениеТарифа,
	|		НеСписанныйСредний.ПриборУчета,
	|		НеСписанныйСредний.Шкала,
	|		НеСписанныйСредний.ТарифнаяЗона,
	|		НеСписанныйСредний.Сумма,
	|		НеСписанныйСредний.ОбъемУслуги,
	|		НеСписанныйСредний.ОбъемУслугиПотребленный,
	|		НЕОПРЕДЕЛЕНО,
	|		НеСписанныйСредний.Поставщик,
	|		ДАТАВРЕМЯ(1, 1, 1),
	|		НеСписанныйСредний.ЗависимаяТочкаУчета,
	|		НеСписанныйСредний.ПриборЗависимой,
	|		НеСписанныйСредний.СпособНачисления,
	|		НеСписанныйСредний.Абонент,
	|		НеСписанныйСредний.СверхНорматива
	|	ИЗ
	|		НеСписанныйСредний КАК НеСписанныйСредний
	|	ГДЕ
	|		(НеСписанныйСредний.Организация, НеСписанныйСредний.Район, НеСписанныйСредний.ЧастныйСектор, НеСписанныйСредний.Строение, НеСписанныйСредний.Помещение, НеСписанныйСредний.ТочкаУчета, НеСписанныйСредний.Услуга) В
	|				(ВЫБРАТЬ
	|					НачисленныйОбъем.Организация,
	|					НачисленныйОбъем.Район,
	|					НачисленныйОбъем.ЧастныйСектор,
	|					НачисленныйОбъем.Строение,
	|					НачисленныйОбъем.Помещение,
	|					НачисленныйОбъем.ТочкаУчета,
	|					НачисленныйОбъем.Услуга
	|				ИЗ
	|					НачисленныйОбъем КАК НачисленныйОбъем
	|				ГДЕ
	|					НачисленныйОбъем.СниматьНачисленныйСреднийЗависимыхТочек)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НеСписанныйСредний.Организация,
	|		НеСписанныйСредний.Район,
	|		ВЫБОР
	|			КОГДА НеСписанныйСредний.ЧастныйСектор
	|				ТОГДА ЗНАЧЕНИЕ(Справочник.энргСтроения.ПустаяСсылка)
	|			ИНАЧЕ НеСписанныйСредний.Строение
	|		КОНЕЦ,
	|		НеСписанныйСредний.ЧастныйСектор,
	|		НеСписанныйСредний.Строение,
	|		НеСписанныйСредний.Помещение,
	|		НеСписанныйСредний.ПериодНачисления,
	|		НеСписанныйСредний.ТочкаУчета,
	|		НеСписанныйСредний.Услуга,
	|		НеСписанныйСредний.НаправлениеИспользованияТУ,
	|		НеСписанныйСредний.ЗначениеТарифа,
	|		НеСписанныйСредний.ПриборУчета,
	|		НеСписанныйСредний.Шкала,
	|		НеСписанныйСредний.ТарифнаяЗона,
	|		НеСписанныйСредний.Сумма,
	|		НеСписанныйСредний.ОбъемУслуги,
	|		НеСписанныйСредний.ОбъемУслугиПотребленный,
	|		НЕОПРЕДЕЛЕНО,
	|		НеСписанныйСредний.Поставщик,
	|		ДАТАВРЕМЯ(1, 1, 1),
	|		НеСписанныйСредний.ЗависимаяТочкаУчета,
	|		НеСписанныйСредний.ПриборЗависимой,
	|		НеСписанныйСредний.СпособНачисления,
	|		НеСписанныйСредний.Абонент,
	|		НеСписанныйСредний.СверхНорматива
	|	ИЗ
	|		НеСписанныйСредний КАК НеСписанныйСредний
	|	ГДЕ
	|		(НеСписанныйСредний.Организация, НеСписанныйСредний.Район, НеСписанныйСредний.ЧастныйСектор, НеСписанныйСредний.Строение, НеСписанныйСредний.Помещение, НеСписанныйСредний.ТочкаУчета, НеСписанныйСредний.Услуга) В
	|				(ВЫБРАТЬ
	|					НачисленныйОбъем.Организация,
	|					НачисленныйОбъем.Район,
	|					НачисленныйОбъем.ЧастныйСектор,
	|					НачисленныйОбъем.Строение,
	|					НачисленныйОбъем.Помещение,
	|					НачисленныйОбъем.ТочкаУчета,
	|					НачисленныйОбъем.Услуга
	|				ИЗ
	|					НачисленныйОбъем КАК НачисленныйОбъем
	|				ГДЕ
	|					НачисленныйОбъем.СниматьНачисленныйСреднийПоФормулам)
	|		И НеСписанныйСредний.СпособНачисления = ЗНАЧЕНИЕ(ПЕРЕЧИСЛЕНИЕ.энргСпособНачислений.ПоПриборам)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НеСписанныйСредний.Организация,
	|		НеСписанныйСредний.Район,
	|		ВЫБОР
	|			КОГДА НеСписанныйСредний.ЧастныйСектор
	|				ТОГДА ЗНАЧЕНИЕ(Справочник.энргСтроения.ПустаяСсылка)
	|			ИНАЧЕ НеСписанныйСредний.Строение
	|		КОНЕЦ,
	|		НеСписанныйСредний.ЧастныйСектор,
	|		НеСписанныйСредний.Строение,
	|		НеСписанныйСредний.Помещение,
	|		НеСписанныйСредний.ПериодНачисления,
	|		НеСписанныйСредний.ТочкаУчета,
	|		НеСписанныйСредний.Услуга,
	|		НеСписанныйСредний.НаправлениеИспользованияТУ,
	|		НеСписанныйСредний.ЗначениеТарифа,
	|		НеСписанныйСредний.ПриборУчета,
	|		НеСписанныйСредний.Шкала,
	|		НеСписанныйСредний.ТарифнаяЗона,
	|		НеСписанныйСредний.Сумма,
	|		НеСписанныйСредний.ОбъемУслуги,
	|		НеСписанныйСредний.ОбъемУслугиПотребленный,
	|		НЕОПРЕДЕЛЕНО,
	|		НеСписанныйСредний.Поставщик,
	|		ДАТАВРЕМЯ(1, 1, 1),
	|		НеСписанныйСредний.ЗависимаяТочкаУчета,
	|		НеСписанныйСредний.ПриборЗависимой,
	|		НеСписанныйСредний.СпособНачисления,
	|		НеСписанныйСредний.Абонент,
	|		НеСписанныйСредний.СверхНорматива
	|	ИЗ
	|		НеСписанныйСредний КАК НеСписанныйСредний
	|	ГДЕ
	|		(НеСписанныйСредний.Организация, НеСписанныйСредний.Район, НеСписанныйСредний.ЧастныйСектор, НеСписанныйСредний.Строение, НеСписанныйСредний.Помещение, НеСписанныйСредний.Услуга) В
	|				(ВЫБРАТЬ
	|					НачисленныйОбъем.Организация,
	|					НачисленныйОбъем.Район,
	|					НачисленныйОбъем.ЧастныйСектор,
	|					НачисленныйОбъем.Строение,
	|					НачисленныйОбъем.Помещение,
	|					НачисленныйОбъем.Услуга
	|				ИЗ
	|					НачисленныйОбъем КАК НачисленныйОбъем
	|				ГДЕ
	|					НачисленныйОбъем.ЕстьСреднийПоВсемТочкамУслуги)
	|		И НеСписанныйСредний.СпособНачисления В (ЗНАЧЕНИЕ(ПЕРЕЧИСЛЕНИЕ.энргСпособНачислений.ПоНормативу))) КАК ВложенныйЗапрос
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.энргПерерасчет КАК энргПерерасчет
	|		ПО ВложенныйЗапрос.Район = энргПерерасчет.Район
	|			И (энргПерерасчет.КлючПомещения = ЗНАЧЕНИЕ(Справочник.энргКлючиПомещений.ПустаяСсылка))
	|			И (ВЫБОР
	|				КОГДА ВложенныйЗапрос.ЧастныйСектор
	|					ТОГДА энргПерерасчет.Строение = ЗНАЧЕНИЕ(Справочник.энргСтроения.ПустаяСсылка)
	|				ИНАЧЕ ВложенныйЗапрос.Строение = энргПерерасчет.Строение
	|			КОНЕЦ)
	|			И (энргПерерасчет.Организация = &Организация)
	|			И (НАЧАЛОПЕРИОДА(энргПерерасчет.Дата, МЕСЯЦ) = &ПериодНачисления)
	|			И (энргПерерасчет.ВидОперации = ЗНАЧЕНИЕ(Перечисление.энргВидыОпераций.энргПерерасчет_СвязанныйПерерасчет))
	|
	|УПОРЯДОЧИТЬ ПО
	|	ВложенныйЗапрос.Район,
	|	ВложенныйЗапрос.МКД,
	|	ВложенныйЗапрос.ЧастныйСектор,
	|	ВложенныйЗапрос.Строение,
	|	ВложенныйЗапрос.Помещение";  	
	
	Если НачисленныйСреднийОбъем <> Неопределено тогда
		Текст 						= Текст + ТекстРазделить + "УНИЧТОЖИТЬ ДанныеДляСписанияМинДата";
		Текст 						= Текст + ТекстРазделить + "УНИЧТОЖИТЬ ДанныеДляСписанияМинРегистратор";
		
		Текст 						= Текст + ТекстРазделить + "УНИЧТОЖИТЬ НеСписанныйСредний"; 						
		Текст 						= Текст + ТекстРазделить + "УНИЧТОЖИТЬ НеСписанныйСреднийБезГруппировки"; 		
	КонецЕсли;  
	
	Если ЧастныйСектор = Неопределено Тогда
		Текст 						= СтрЗаменить(Текст,"И (энргПредоставленныеПоказания.ЧастныйСектор = &ЧастныйСектор)","");
		Текст						= СтрЗаменить(Текст,"И (энргПредоставленныеПоказания.Строение = &Строение)","");
		Текст 						= СтрЗаменить(Текст,"И (энргПредоставленныеПоказания.Помещение = &Помещение)","");
		
		Текст 						= СтрЗаменить(Текст,"И ЧастныйСектор = &ЧастныйСектор","");
		Текст 						= СтрЗаменить(Текст,"И Строение = &Строение","");
		Текст 						= СтрЗаменить(Текст,"И Помещение = &Помещение","");
		
	ИначеЕсли НЕ ЗначениеЗаполнено(Строение) Тогда
		Текст 						= СтрЗаменить(Текст,"И (энргПредоставленныеПоказания.Строение = &Строение)","");
		Текст 						= СтрЗаменить(Текст,"И (энргПредоставленныеПоказания.Помещение = &Помещение)","");
		
		Текст 						= СтрЗаменить(Текст,"И Строение = &Строение","");
		Текст 						= СтрЗаменить(Текст,"И Помещение = &Помещение","");
		
	ИначеЕсли НЕ ЗначениеЗаполнено(Помещение) И Не ЧастныйСектор Тогда
		Текст 						= СтрЗаменить(Текст,"И (энргПредоставленныеПоказания.Помещение = &Помещение)","");
		Текст 						= СтрЗаменить(Текст,"И Помещение = &Помещение","");
	КонецЕсли;
		 
	Запрос  						= Новый Запрос;
	Запрос.МенеджерВременныхТаблиц 	= МВТ;
	Запрос.УстановитьПараметр("ПериодНачисления",			ПериодНачисления);
	Запрос.УстановитьПараметр("Организация",				Организация);
	Запрос.УстановитьПараметр("Район",						Район);
	Запрос.УстановитьПараметр("НачисленныйСреднийОбъем", 	НачисленныйСреднийОбъем);
	Запрос.УстановитьПараметр("КонецПериода", 				КонецПериодаРасчета);	
	Запрос.УстановитьПараметр("ЧастныйСектор",				ЧастныйСектор);
	Запрос.УстановитьПараметр("Строение",					Строение);
	Запрос.УстановитьПараметр("Помещение",					Помещение);
			
	Запрос.Текст 					= Текст;
	Результат  						= Запрос.Выполнить();  
	Возврат Результат;
КонецФункции

Функция РезультатОтменитьСнятьСредниеНачисления(ПериодНачисления,Организация,Район,ЧастныйСектор,Строение)
	
	Запрос  		= Новый Запрос;
	Запрос.УстановитьПараметр("ПериодНачисления",	ПериодНачисления);
	Запрос.УстановитьПараметр("Организация",		Организация);
	Запрос.УстановитьПараметр("Район",				Район);
	Запрос.УстановитьПараметр("Строение",			Строение);
	Запрос.Текст 	= 
	"ВЫБРАТЬ
	|	энргПерерасчет.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.энргПерерасчет КАК энргПерерасчет
	|ГДЕ
	|	НЕ энргПерерасчет.ПометкаУдаления
	|	И энргПерерасчет.ВидОперации = ЗНАЧЕНИЕ(Перечисление.энргВидыОпераций.энргПерерасчет_СвязанныйПерерасчет)
	|	И энргПерерасчет.Район = &Район
	|	И энргПерерасчет.Организация = &Организация
	|	И НАЧАЛОПЕРИОДА(энргПерерасчет.Дата, МЕСЯЦ) = &ПериодНачисления
	|	И энргПерерасчет.Строение = &Строение";
	
	Если ЧастныйСектор = Неопределено Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"И энргПерерасчет.Строение = &Строение","");
	ИначеЕсли ЧастныйСектор Тогда
		Запрос.УстановитьПараметр("Строение",		Справочники.энргСтроения.ПустаяСсылка());
	КонецЕсли;
	
	Результат  = Запрос.Выполнить();
	Возврат Результат.Выбрать();
	
КонецФункции

Функция РезультатОтменитьКорректировкуСезонныхУслуг(ПериодНачисления,Организация,Район,Строение)
	
	Запрос  		= Новый Запрос;
	Запрос.УстановитьПараметр("ПериодНачисления",	ПериодНачисления);
	Запрос.УстановитьПараметр("Организация",		Организация);
	Запрос.УстановитьПараметр("Район",				Район);
	Запрос.УстановитьПараметр("Строение",			Строение);
	Запрос.Текст 	= 
	"ВЫБРАТЬ
	|	энргПерерасчет.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.энргПерерасчет КАК энргПерерасчет
	|ГДЕ
	|	НЕ энргПерерасчет.ПометкаУдаления
	|	И энргПерерасчет.ВидОперации = ЗНАЧЕНИЕ(Перечисление.энргВидыОпераций.энргПерерасчет_КорректировкаГодовогоПотребленияСезонныхУслуг)
	|	И энргПерерасчет.Район = &Район
	|	И энргПерерасчет.Организация = &Организация
	|	И НАЧАЛОПЕРИОДА(энргПерерасчет.Дата, МЕСЯЦ) = &ПериодНачисления
	|	И энргПерерасчет.Строение = &Строение";
	
	Если Строение = Неопределено Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"И энргПерерасчет.Строение = &Строение","");
	КонецЕсли;
	
	Результат  = Запрос.Выполнить();
	Возврат Результат.Выбрать();
	
КонецФункции

#КонецОбласти

#Область СнятьСредниеНачисленияМКД_ВспомогательныеПроцедурыИФункции

Процедура ПрочитатьНеСписанныйСреднийМКД(МВТ,Организация,Район, МКД, НачалоПериодаРасчета,ТаблицаПриемник = Неопределено)
	Запрос  						= Новый Запрос;
	Запрос.МенеджерВременныхТаблиц 	= МВТ;
	Текст 	=
	"ВЫБРАТЬ
	|	энргНачисленныйСреднийОбъемОстатки.Район КАК Район,
	|	энргНачисленныйСреднийОбъемОстатки.МКД КАК МКД,
	|	энргНачисленныйСреднийОбъемОстатки.ПериодНачисления КАК ПериодНачисления,
	|	энргНачисленныйСреднийОбъемОстатки.ТочкаУчета КАК ТочкаУчета,
	|	энргНачисленныйСреднийОбъемОстатки.Услуга КАК Услуга,
	|	энргНачисленныйСреднийОбъемОстатки.ПриборУчета КАК ПриборУчета,
	|	энргНачисленныйСреднийОбъемОстатки.Шкала КАК Шкала,
	|	энргНачисленныйСреднийОбъемОстатки.ТарифнаяЗона КАК ТарифнаяЗона,
	|	энргНачисленныйСреднийОбъемОстатки.Поставщик КАК Поставщик,
	|	энргНачисленныйСреднийОбъемОстатки.ОбъемУслугиОстаток КАК ОбъемУслуги,
	|	энргНачисленныйСреднийОбъемОстатки.СпособНачисления КАК СпособНачисления
	|ПОМЕСТИТЬ НеСписанныйСредний
	|ИЗ
	|	РегистрНакопления.энргНачисленныйСреднийОбъемМКД.Остатки(
	|			&НачалоПериодаРасчетаГраница,
	|			Организация = &Организация
	|				И Район = &Район
	|				И МКД = &МКД) КАК энргНачисленныйСреднийОбъемОстатки";
	
	Если ЗначениеЗаполнено(МКД) тогда
		Запрос.УстановитьПараметр("МКД",				МКД);
	иначе 		
		Текст 		= СтрЗаменить(Текст,"И МКД = &МКД","");	
	КонецЕсли;  
	
	Запрос.УстановитьПараметр("НачалоПериодаРасчетаГраница",Новый Граница(НачалоПериодаРасчета,ВидГраницы.Исключая));
	Запрос.УстановитьПараметр("Район",							Район);
	Запрос.УстановитьПараметр("Организация",					Организация);
	Запрос.Текст 			= Текст;
	
	Если ТаблицаПриемник = Неопределено тогда
		Запрос.Выполнить();
	иначе
		Запрос.Текст 		= СтрЗаменить(Запрос.Текст,"ПОМЕСТИТЬ НеСписанныйСредний","");
		Результат  			= Запрос.Выполнить();
		Выборка 			= Результат.Выбрать();
		Пока Выборка.Следующий() цикл
			ЗаполнитьЗначенияСвойств(ТаблицаПриемник.добавить(),Выборка);
		КонецЦикла;  		 
	КонецЕсли;
КонецПроцедуры

Функция РезультатЗапросаПерерасчетСреднегоМКД(МВТ,Организация,ПериодНачисления,Район,МКД,НачисленныйСреднийОбъем=Неопределено)
	
	ТекстРазделить 						= " 
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|";  
	
	Текст 	= "";
	Если НачисленныйСреднийОбъем <> Неопределено тогда
		Текст 	=
		"ВЫБРАТЬ
		|	НеСписанныйСредний.Район,
		|	НеСписанныйСредний.МКД,
		|	НеСписанныйСредний.ПериодНачисления,
		|	НеСписанныйСредний.ТочкаУчета,
		|	НеСписанныйСредний.Услуга,
		|	НеСписанныйСредний.ПриборУчета,
		|	НеСписанныйСредний.ОбъемУслуги,
		|	НеСписанныйСредний.Поставщик
		|ПОМЕСТИТЬ НеСписанныйСреднийБезГруппировки
		|ИЗ
		|	&НачисленныйСреднийОбъем КАК НеСписанныйСредний
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	НеСписанныйСреднийБезГруппировки.Район,
		|	НеСписанныйСреднийБезГруппировки.МКД,
		|	НеСписанныйСреднийБезГруппировки.ПериодНачисления,
		|	НеСписанныйСреднийБезГруппировки.ТочкаУчета,
		|	НеСписанныйСреднийБезГруппировки.Услуга,
		|	НеСписанныйСреднийБезГруппировки.ПриборУчета,
		|	СУММА(НеСписанныйСреднийБезГруппировки.ОбъемУслуги) КАК ОбъемУслуги,
		|	НеСписанныйСреднийБезГруппировки.Поставщик
		|ПОМЕСТИТЬ НеСписанныйСредний
		|ИЗ
		|	НеСписанныйСреднийБезГруппировки КАК НеСписанныйСреднийБезГруппировки
		|
		|СГРУППИРОВАТЬ ПО
		|	НеСписанныйСреднийБезГруппировки.Район,
		|	НеСписанныйСреднийБезГруппировки.МКД,
		|	НеСписанныйСреднийБезГруппировки.ПериодНачисления,
		|	НеСписанныйСреднийБезГруппировки.ТочкаУчета,
		|	НеСписанныйСреднийБезГруппировки.Услуга,
		|	НеСписанныйСреднийБезГруппировки.ПриборУчета,
		|	НеСписанныйСреднийБезГруппировки.Поставщик";
		
		Текст = Текст + ТекстРазделить;
	КонецЕсли;  
	
	Текст 	=Текст + 
	"ВЫБРАТЬ
	|	НеСписанныйСредний.Район КАК Район,
	|	НеСписанныйСредний.МКД КАК МКД,
	|	НеСписанныйСредний.ПериодНачисления КАК ПериодНачисления,
	|	НеСписанныйСредний.ТочкаУчета КАК ТочкаУчета,
	|	НеСписанныйСредний.Услуга КАК Услуга,
	|	НеСписанныйСредний.ПриборУчета КАК ПриборУчета,
	|	НеСписанныйСредний.Шкала КАК Шкала,
	|	НеСписанныйСредний.ТарифнаяЗона КАК ТарифнаяЗона,
	|	НеСписанныйСредний.ОбъемУслуги КАК ОбъемУслуги,
	|	МИНИМУМ(энргПредоставленныеПоказания.ДатаРегистратора) КАК ДатаРегистратора,
	|	НеСписанныйСредний.Поставщик КАК Поставщик,
	|	НеСписанныйСредний.СпособНачисления КАК СпособНачисления
	|ПОМЕСТИТЬ ДанныеДляСписанияМинДата
	|ИЗ
	|	РегистрСведений.энргПредоставленныеПоказанияМКД КАК энргПредоставленныеПоказания
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ НеСписанныйСредний КАК НеСписанныйСредний
	|		ПО энргПредоставленныеПоказания.Район = НеСписанныйСредний.Район
	|			И энргПредоставленныеПоказания.МКД = НеСписанныйСредний.МКД
	|			И энргПредоставленныеПоказания.ПриборУчета = НеСписанныйСредний.ПриборУчета
	|			И энргПредоставленныеПоказания.Шкала = НеСписанныйСредний.Шкала
	|			И энргПредоставленныеПоказания.ТарифнаяЗона = НеСписанныйСредний.ТарифнаяЗона
	|			И (энргПредоставленныеПоказания.ПериодНачисления = &ПериодНачисления)
	|			И (энргПредоставленныеПоказания.Организация = &Организация)
	|			И (энргПредоставленныеПоказания.Район = &Район)
	|			И (энргПредоставленныеПоказания.МКД = &МКД)
	|			И (энргПредоставленныеПоказания.ПоказанияТекущегоПериода)
	|
	|СГРУППИРОВАТЬ ПО
	|	НеСписанныйСредний.Район,
	|	НеСписанныйСредний.МКД,
	|	НеСписанныйСредний.ПериодНачисления,
	|	НеСписанныйСредний.ТочкаУчета,
	|	НеСписанныйСредний.Услуга,
	|	НеСписанныйСредний.ПриборУчета,
	|	НеСписанныйСредний.Шкала,
	|	НеСписанныйСредний.ТарифнаяЗона,
	|	НеСписанныйСредний.ОбъемУслуги,
	|	НеСписанныйСредний.Поставщик,
	|	НеСписанныйСредний.СпособНачисления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДанныеДляСписанияМинДата.Район КАК Район,
	|	ДанныеДляСписанияМинДата.МКД КАК МКД,
	|	ДанныеДляСписанияМинДата.ПериодНачисления КАК ПериодНачисления,
	|	ДанныеДляСписанияМинДата.ТочкаУчета КАК ТочкаУчета,
	|	ДанныеДляСписанияМинДата.Услуга КАК Услуга,
	|	ДанныеДляСписанияМинДата.ПриборУчета КАК ПриборУчета,
	|	ДанныеДляСписанияМинДата.Шкала КАК Шкала,
	|	ДанныеДляСписанияМинДата.ТарифнаяЗона КАК ТарифнаяЗона,
	|	ДанныеДляСписанияМинДата.ОбъемУслуги КАК ОбъемУслуги,
	|	ДанныеДляСписанияМинДата.ДатаРегистратора КАК ДатаРегистратора,
	|	МИНИМУМ(энргПредоставленныеПоказания.ДокРегистратор) КАК ДокРегистратор,
	|	ДанныеДляСписанияМинДата.Поставщик КАК Поставщик,
	|	ДанныеДляСписанияМинДата.СпособНачисления КАК СпособНачисления
	|ПОМЕСТИТЬ ДанныеДляСписанияМинРегистратор
	|ИЗ
	|	ДанныеДляСписанияМинДата КАК ДанныеДляСписанияМинДата
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.энргПредоставленныеПоказанияМКД КАК энргПредоставленныеПоказания
	|		ПО ДанныеДляСписанияМинДата.Район = энргПредоставленныеПоказания.Район
	|			И ДанныеДляСписанияМинДата.МКД = энргПредоставленныеПоказания.МКД
	|			И ДанныеДляСписанияМинДата.ПриборУчета = энргПредоставленныеПоказания.ПриборУчета
	|			И ДанныеДляСписанияМинДата.Шкала = энргПредоставленныеПоказания.Шкала
	|			И ДанныеДляСписанияМинДата.ТарифнаяЗона = энргПредоставленныеПоказания.ТарифнаяЗона
	|			И ДанныеДляСписанияМинДата.ДатаРегистратора = энргПредоставленныеПоказания.ДатаРегистратора
	|			И (энргПредоставленныеПоказания.Организация = &Организация)
	|			И (энргПредоставленныеПоказания.ПериодНачисления = &ПериодНачисления)
	|			И (энргПредоставленныеПоказания.Район = &Район)
	|			И (энргПредоставленныеПоказания.МКД = &МКД)
	|			И (энргПредоставленныеПоказания.ПоказанияТекущегоПериода)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДанныеДляСписанияМинДата.Район,
	|	ДанныеДляСписанияМинДата.МКД,
	|	ДанныеДляСписанияМинДата.ПериодНачисления,
	|	ДанныеДляСписанияМинДата.ТочкаУчета,
	|	ДанныеДляСписанияМинДата.Услуга,
	|	ДанныеДляСписанияМинДата.ПриборУчета,
	|	ДанныеДляСписанияМинДата.Шкала,
	|	ДанныеДляСписанияМинДата.ТарифнаяЗона,
	|	ДанныеДляСписанияМинДата.ОбъемУслуги,
	|	ДанныеДляСписанияМинДата.ДатаРегистратора,
	|	ДанныеДляСписанияМинДата.Поставщик,
	|	ДанныеДляСписанияМинДата.СпособНачисления 
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДанныеДляСписанияМинРегистратор.Район КАК Район,
	|	ДанныеДляСписанияМинРегистратор.МКД КАК МКД,
	|	ДанныеДляСписанияМинРегистратор.ПериодНачисления КАК ПериодНачисления,
	|	ДанныеДляСписанияМинРегистратор.ТочкаУчета КАК ТочкаУчета,
	|	ДанныеДляСписанияМинРегистратор.Услуга КАК Услуга,
	|	ДанныеДляСписанияМинРегистратор.ПриборУчета КАК ПриборУчета,
	|	ДанныеДляСписанияМинРегистратор.Шкала КАК Шкала,
	|	ДанныеДляСписанияМинРегистратор.ТарифнаяЗона КАК ТарифнаяЗона,
	|	ДанныеДляСписанияМинРегистратор.ОбъемУслуги КАК ОбъемУслуги,
	|	ДанныеДляСписанияМинРегистратор.ДокРегистратор КАК ДокументОснование,
	|	МАКСИМУМ(ЕСТЬNULL(энргПерерасчет.Ссылка, ЗНАЧЕНИЕ(Документ.энргПерерасчетМКД.Пустаяссылка))) КАК ДокументПерерасчета,
	|	ДанныеДляСписанияМинРегистратор.Поставщик КАК Поставщик,
	|	ДанныеДляСписанияМинРегистратор.СпособНачисления КАК СпособНачисления,
	|	ДанныеДляСписанияМинРегистратор.ДатаРегистратора КАК ДатаДокументаОснования
	|ИЗ
	|	ДанныеДляСписанияМинРегистратор КАК ДанныеДляСписанияМинРегистратор
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.энргПерерасчетМКД КАК энргПерерасчет
	|		ПО ДанныеДляСписанияМинРегистратор.Район = энргПерерасчет.Район
	|			И (НАЧАЛОПЕРИОДА(энргПерерасчет.Дата, МЕСЯЦ) = &ПериодНачисления)
	|			И (энргПерерасчет.Организация = &Организация)
	|			И (энргПерерасчет.ВидОперации = ЗНАЧЕНИЕ(Перечисление.энргВидыОпераций.энргПерерасчетМКД_СвязанныйПерерасчет))
	|
	|СГРУППИРОВАТЬ ПО
	|	ДанныеДляСписанияМинРегистратор.Район,
	|	ДанныеДляСписанияМинРегистратор.МКД,
	|	ДанныеДляСписанияМинРегистратор.ПериодНачисления,
	|	ДанныеДляСписанияМинРегистратор.ТочкаУчета,
	|	ДанныеДляСписанияМинРегистратор.Услуга,
	|	ДанныеДляСписанияМинРегистратор.ПриборУчета,
	|	ДанныеДляСписанияМинРегистратор.Шкала,
	|	ДанныеДляСписанияМинРегистратор.ТарифнаяЗона,
	|	ДанныеДляСписанияМинРегистратор.ОбъемУслуги,
	|	ДанныеДляСписанияМинРегистратор.ДокРегистратор,
	|	ДанныеДляСписанияМинРегистратор.Поставщик,
	|	ДанныеДляСписанияМинРегистратор.СпособНачисления,
	|	ДанныеДляСписанияМинРегистратор.ДатаРегистратора
	|
	|УПОРЯДОЧИТЬ ПО
	|	Район,
	|	МКД"; 	
	
	Если НачисленныйСреднийОбъем <> Неопределено тогда
		
		Текст 						= Текст + ТекстРазделить + "УНИЧТОЖИТЬ ДанныеДляСписанияМинДата";
		Текст 						= Текст + ТекстРазделить + "УНИЧТОЖИТЬ ДанныеДляСписанияМинРегистратор";
		
		Текст 						= Текст + ТекстРазделить + "УНИЧТОЖИТЬ НеСписанныйСредний"; 						
		Текст 						= Текст + ТекстРазделить + "УНИЧТОЖИТЬ НеСписанныйСреднийБезГруппировки"; 		
	КонецЕсли;  
	
	Запрос  						= Новый Запрос;
	Запрос.МенеджерВременныхТаблиц 	= МВТ;
	Запрос.УстановитьПараметр("Организация",				Организация);
	Запрос.УстановитьПараметр("ПериодНачисления",			ПериодНачисления);
	Запрос.УстановитьПараметр("Район",						Район);
	Запрос.УстановитьПараметр("НачисленныйСреднийОбъем", 	НачисленныйСреднийОбъем);
	Если ЗначениеЗаполнено(МКД) тогда
		Запрос.УстановитьПараметр("МКД",					МКД);		
	иначе 		
		Текст 						= СтрЗаменить(Текст,"И МКД = &МКД","");
		Текст 						= СтрЗаменить(Текст,"И (энргПредоставленныеПоказания.МКД = &МКД)","");
	КонецЕсли;
	
	Запрос.Текст 					= Текст;
	Результат  						= Запрос.Выполнить();  
	Возврат Результат;
КонецФункции

#КонецОбласти

#Область ТекстыЗапросов

Функция ТекстЗапросаВспомогательныеДанныеДляКорректировкиПотребленияСезонныхУслуг()
	
Текст  =
	"ВЫБРАТЬ
	|	НастройкиВыполненияГодовойКорректировки.Организация КАК Организация,
	|	НастройкиВыполненияГодовойКорректировки.Район КАК Район,
	|	НастройкиВыполненияГодовойКорректировки.МКД КАК МКД,
	|	ВЫБОР
	|		КОГДА НастройкиВыполненияГодовойКорректировки.НачалоПериода = ДАТАВРЕМЯ(1, 1, 1)
	|			ТОГДА ДОБАВИТЬКДАТЕ(&НачалоГода, ГОД, -1)
	|		ИНАЧЕ ДОБАВИТЬКДАТЕ(ДОБАВИТЬКДАТЕ(&НачалоГода, ГОД, -1), МЕСЯЦ, МЕСЯЦ(НастройкиВыполненияГодовойКорректировки.НачалоПериода) - 1)
	|	КОНЕЦ КАК НачалоПериода,
	|	ВЫБОР
	|		КОГДА НастройкиВыполненияГодовойКорректировки.КонецПериода = ДАТАВРЕМЯ(1, 1, 1)
	|			ТОГДА КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(&НачалоГода, ГОД, -1), ГОД)
	|		ИНАЧЕ ДОБАВИТЬКДАТЕ(ДОБАВИТЬКДАТЕ(&НачалоГода, ГОД, -1), МЕСЯЦ, МЕСЯЦ(НастройкиВыполненияГодовойКорректировки.КонецПериода) - 1)
	|	КОНЕЦ КАК КонецПериода,
	|	НастройкиВыполненияГодовойКорректировки.Месяц КАК Месяц
	|ПОМЕСТИТЬ НастройкиВыполненияГодовойКорректировки
	|ИЗ
	|	РегистрСведений.энргНастройкиВыполненияГодовойКорректировки.СрезПоследних(
	|			&ПериодНачисления,
	|			Организация = &Организация
	|				И Район = &Район
	|				И (МКД = &МКД
	|					ИЛИ МКД = ЗНАЧЕНИЕ(Справочник.энргСтроения.ПустаяСсылка))) КАК НастройкиВыполненияГодовойКорректировки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	энргНастройкаСезонностиУслуг.МКД КАК Строение,
	|	энргНастройкаСезонностиУслуг.Услуга КАК Услуга,
	|	энргНастройкаСезонностиУслуг.НеПрименятьСезонность КАК НеПрименятьСезонность,
	|	энргНастройкаСезонностиУслуг.КорректироватьГодовойОбъем КАК КорректироватьГодовойОбъем,
	|	0 КАК Приоритет
	|ПОМЕСТИТЬ УслугиКорректироватьГодовойОбъемНабор
	|ИЗ
	|	РегистрСведений.энргНастройкаСезонностиУслуг.СрезПоследних(
	|			&ПериодНачисления,
	|			Организация = &Организация
	|				И Район = &Район
	|				И НаправлениеИспользованияТУ = ЗНАЧЕНИЕ(Справочник.энргНаправлениеИспользованияТочекУчета.ОсновноеНаправление)
	|				И НЕ МКД = ЗНАЧЕНИЕ(Справочник.энргСтроения.ПустаяСсылка)
	|				И МКД = &МКД) КАК энргНастройкаСезонностиУслуг
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	энргНастройкаСезонностиУслуг.МКД,
	|	энргНастройкаСезонностиУслуг.Услуга,
	|	энргНастройкаСезонностиУслуг.НеПрименятьСезонность,
	|	энргНастройкаСезонностиУслуг.КорректироватьГодовойОбъем,
	|	1
	|ИЗ
	|	РегистрСведений.энргНастройкаСезонностиУслуг.СрезПоследних(
	|			&ПериодНачисления,
	|			Организация = &Организация
	|				И Район = &Район
	|				И НаправлениеИспользованияТУ = ЗНАЧЕНИЕ(Справочник.энргНаправлениеИспользованияТочекУчета.ОсновноеНаправление)
	|				И МКД = ЗНАЧЕНИЕ(Справочник.энргСтроения.ПустаяСсылка)) КАК энргНастройкаСезонностиУслуг
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВложенныйЗапрос.Строение КАК Строение,
	|	ВложенныйЗапрос.Услуга КАК Услуга
	|ПОМЕСТИТЬ УслугиКорректироватьГодовойОбъем
	|ИЗ
	|	(ВЫБРАТЬ
	|		УслугиКорректироватьГодовойОбъемНабор.Строение КАК Строение,
	|		УслугиКорректироватьГодовойОбъемНабор.Услуга КАК Услуга,
	|		МИНИМУМ(УслугиКорректироватьГодовойОбъемНабор.Приоритет) КАК Приоритет
	|	ИЗ
	|		УслугиКорректироватьГодовойОбъемНабор КАК УслугиКорректироватьГодовойОбъемНабор
	|	
	|	СГРУППИРОВАТЬ ПО
	|		УслугиКорректироватьГодовойОбъемНабор.Строение,
	|		УслугиКорректироватьГодовойОбъемНабор.Услуга) КАК ВложенныйЗапрос
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ УслугиКорректироватьГодовойОбъемНабор КАК УслугиКорректироватьГодовойОбъемНабор
	|		ПО ВложенныйЗапрос.Строение = УслугиКорректироватьГодовойОбъемНабор.Строение
	|			И ВложенныйЗапрос.Услуга = УслугиКорректироватьГодовойОбъемНабор.Услуга
	|			И ВложенныйЗапрос.Приоритет = УслугиКорректироватьГодовойОбъемНабор.Приоритет
	|ГДЕ
	|	УслугиКорректироватьГодовойОбъемНабор.НеПрименятьСезонность
	|	И УслугиКорректироватьГодовойОбъемНабор.КорректироватьГодовойОбъем
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВложенныйЗапрос.Организация КАК Организация,
	|	ВложенныйЗапрос.Район КАК Район,
	|	ВложенныйЗапрос.ЧастныйСектор КАК ЧастныйСектор,
	|	ВложенныйЗапрос.Строение КАК Строение,
	|	ВложенныйЗапрос.Помещение КАК Помещение,
	|	ВложенныйЗапрос.Абонент КАК Абонент,
	|	ВложенныйЗапрос.Услуга КАК Услуга,
	|	ВложенныйЗапрос.КорректировкаТекущегоПериода КАК КорректировкаТекущегоПериода,
	|	ВложенныйЗапрос.НачалоПериода КАК НачалоПериода,
	|	ВложенныйЗапрос.КонецПериода КАК КонецПериода
	|ПОМЕСТИТЬ ТочкиДляКорректировкиТекущийПериод
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВложенныйЗапрос.Организация КАК Организация,
	|		ВложенныйЗапрос.Район КАК Район,
	|		ВложенныйЗапрос.ЧастныйСектор КАК ЧастныйСектор,
	|		ВложенныйЗапрос.Строение КАК Строение,
	|		ВложенныйЗапрос.Помещение КАК Помещение,
	|		ВложенныйЗапрос.Абонент КАК Абонент,
	|		ВложенныйЗапрос.Услуга КАК Услуга,
	|		ВложенныйЗапрос.КорректировкаТекущегоПериода КАК КорректировкаТекущегоПериода,
	|		ЕСТЬNULL(НастройкиВыполненияГодовойКорректировкиМКД.НачалоПериода, ЕСТЬNULL(НастройкиВыполненияГодовойКорректировкиРайон.НачалоПериода, ДОБАВИТЬКДАТЕ(&НачалоГода, ГОД, -1))) КАК НачалоПериода,
	|		ЕСТЬNULL(НастройкиВыполненияГодовойКорректировкиМКД.КонецПериода, ЕСТЬNULL(НастройкиВыполненияГодовойКорректировкиРайон.КонецПериода, КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(&НачалоГода, ГОД, -1), ГОД))) КАК КонецПериода
	|	ИЗ
	|		(ВЫБРАТЬ
	|			энргСтабильныеПериоды.Организация КАК Организация,
	|			энргСтабильныеПериоды.Район КАК Район,
	|			энргСтабильныеПериоды.ЧастныйСектор КАК ЧастныйСектор,
	|			энргСтабильныеПериоды.Строение КАК Строение,
	|			энргСтабильныеПериоды.Помещение КАК Помещение,
	|			энргСтабильныеПериоды.Абонент КАК Абонент,
	|			энргСтабильныеПериоды.Услуга КАК Услуга,
	|			ИСТИНА КАК КорректировкаТекущегоПериода
	|		ИЗ
	|			РегистрСведений.энргСтабильныеПериоды КАК энргСтабильныеПериоды
	|				ВНУТРЕННЕЕ СОЕДИНЕНИЕ УслугиКорректироватьГодовойОбъем КАК УслугиКорректироватьГодовойОбъем
	|				ПО (ВЫБОР
	|						КОГДА энргСтабильныеПериоды.ЧастныйСектор
	|							ТОГДА ЗНАЧЕНИЕ(Справочник.энргСтроения.ПУстаяСсылка)
	|						ИНАЧЕ энргСтабильныеПериоды.Строение
	|					КОНЕЦ = УслугиКорректироватьГодовойОбъем.Строение)
	|					И энргСтабильныеПериоды.Услуга = УслугиКорректироватьГодовойОбъем.Услуга
	|					И (энргСтабильныеПериоды.ПериодНачисления = &ПериодНачисления)
	|					И (энргСтабильныеПериоды.Организация = &Организация)
	|					И (энргСтабильныеПериоды.Район = &Район)
	|					И (энргСтабильныеПериоды.ЧастныйСектор = &ЧастныйСектор)
	|					И (энргСтабильныеПериоды.Строение = &Строение)
	|					И (энргСтабильныеПериоды.Помещение = &Помещение)
	|		
	|		СГРУППИРОВАТЬ ПО
	|			энргСтабильныеПериоды.Организация,
	|			энргСтабильныеПериоды.Район,
	|			энргСтабильныеПериоды.ЧастныйСектор,
	|			энргСтабильныеПериоды.Строение,
	|			энргСтабильныеПериоды.Помещение,
	|			энргСтабильныеПериоды.Абонент,
	|			энргСтабильныеПериоды.Услуга
	|		
	|		ИМЕЮЩИЕ
	|			КОЛИЧЕСТВО(РАЗЛИЧНЫЕ энргСтабильныеПериоды.УслугаПодключена) > 1
	|		
	|		ОБЪЕДИНИТЬ ВСЕ
	|		
	|		ВЫБРАТЬ
	|			ВложенныйЗапрос.Организация,
	|			ВложенныйЗапрос.Район,
	|			ВложенныйЗапрос.ЧастныйСектор,
	|			ВложенныйЗапрос.Строение,
	|			ВложенныйЗапрос.Помещение,
	|			ВложенныйЗапрос.Абонент,
	|			ВложенныйЗапрос.Услуга,
	|			ЛОЖЬ
	|		ИЗ
	|			(ВЫБРАТЬ
	|				энргСтабильныеПериоды.Организация КАК Организация,
	|				энргСтабильныеПериоды.Район КАК Район,
	|				энргСтабильныеПериоды.ЧастныйСектор КАК ЧастныйСектор,
	|				энргСтабильныеПериоды.Строение КАК Строение,
	|				энргСтабильныеПериоды.Помещение КАК Помещение,
	|				энргСтабильныеПериоды.Услуга КАК Услуга,
	|				энргСтабильныеПериоды.Абонент КАК Абонент
	|			ИЗ
	|				РегистрСведений.энргСтабильныеПериоды КАК энргСтабильныеПериоды
	|					ЛЕВОЕ СОЕДИНЕНИЕ УслугиКорректироватьГодовойОбъемНабор КАК УслугиКорректироватьГодовойОбъемНабор
	|					ПО энргСтабильныеПериоды.Услуга = УслугиКорректироватьГодовойОбъемНабор.Услуга
	|						И (ВЫБОР
	|							КОГДА энргСтабильныеПериоды.ЧастныйСектор
	|								ТОГДА ЗНАЧЕНИЕ(Справочник.энргСтроения.ПУстаяСсылка)
	|							ИНАЧЕ энргСтабильныеПериоды.Строение
	|						КОНЕЦ = УслугиКорректироватьГодовойОбъемНабор.Строение)
	|			ГДЕ
	|				энргСтабильныеПериоды.Организация = &Организация
	|				И энргСтабильныеПериоды.ПериодНачисления = &ПериодНачисления
	|				И энргСтабильныеПериоды.Район = &Район
	|				И энргСтабильныеПериоды.ЧастныйСектор = &ЧастныйСектор
	|				И энргСтабильныеПериоды.Строение = &Строение
	|				И энргСтабильныеПериоды.Помещение = &Помещение
	|				И энргСтабильныеПериоды.НомерПозиции = 0
	|				И УслугиКорректироватьГодовойОбъемНабор.Строение ЕСТЬ NULL) КАК ВложенныйЗапрос
	|				ВНУТРЕННЕЕ СОЕДИНЕНИЕ УслугиКорректироватьГодовойОбъем КАК УслугиКорректироватьГодовойОбъем
	|				ПО ВложенныйЗапрос.Услуга = УслугиКорректироватьГодовойОбъем.Услуга
	|					И (УслугиКорректироватьГодовойОбъем.Строение = ЗНАЧЕНИЕ(Справочник.энргСтроения.ПустаяСсылка))
	|		
	|		ОБЪЕДИНИТЬ ВСЕ
	|		
	|		ВЫБРАТЬ
	|			энргСтабильныеПериоды.Организация,
	|			энргСтабильныеПериоды.Район,
	|			энргСтабильныеПериоды.ЧастныйСектор,
	|			энргСтабильныеПериоды.Строение,
	|			энргСтабильныеПериоды.Помещение,
	|			энргСтабильныеПериоды.Абонент,
	|			энргСтабильныеПериоды.Услуга,
	|			ЛОЖЬ
	|		ИЗ
	|			РегистрСведений.энргСтабильныеПериоды КАК энргСтабильныеПериоды
	|				ВНУТРЕННЕЕ СОЕДИНЕНИЕ УслугиКорректироватьГодовойОбъем КАК УслугиКорректироватьГодовойОбъем
	|				ПО (энргСтабильныеПериоды.Организация = &Организация)
	|					И (энргСтабильныеПериоды.ПериодНачисления = НАЧАЛОПЕРИОДА(&ПериодНачисления, ГОД))
	|					И (энргСтабильныеПериоды.Район = &Район)
	|					И (энргСтабильныеПериоды.ЧастныйСектор = &ЧастныйСектор)
	|					И (энргСтабильныеПериоды.Строение = &Строение)
	|					И (энргСтабильныеПериоды.Помещение = &Помещение)
	|					И (энргСтабильныеПериоды.НомерПозиции = 0)
	|					И (энргСтабильныеПериоды.УслугаПодключена)
	|					И (ВЫБОР
	|						КОГДА энргСтабильныеПериоды.ЧастныйСектор
	|							ТОГДА ЗНАЧЕНИЕ(Справочник.энргСтроения.ПУстаяСсылка)
	|						ИНАЧЕ энргСтабильныеПериоды.Строение
	|					КОНЕЦ = УслугиКорректироватьГодовойОбъем.Строение)
	|					И энргСтабильныеПериоды.Услуга = УслугиКорректироватьГодовойОбъем.Услуга) КАК ВложенныйЗапрос
	|			ЛЕВОЕ СОЕДИНЕНИЕ НастройкиВыполненияГодовойКорректировки КАК НастройкиВыполненияГодовойКорректировкиМКД
	|			ПО ВложенныйЗапрос.Организация = НастройкиВыполненияГодовойКорректировкиМКД.Организация
	|				И ВложенныйЗапрос.Район = НастройкиВыполненияГодовойКорректировкиМКД.Район
	|				И (ВЫБОР
	|					КОГДА ВложенныйЗапрос.ЧастныйСектор
	|						ТОГДА ЗНАЧЕНИЕ(Справочник.энргСтроения.ПустаяСсылка)
	|					ИНАЧЕ ВложенныйЗапрос.Строение
	|				КОНЕЦ = НастройкиВыполненияГодовойКорректировкиМКД.МКД)
	|				И (НЕ НастройкиВыполненияГодовойКорректировкиМКД.МКД = ЗНАЧЕНИЕ(Справочник.энргСтроения.ПустаяСсылка))
	|			ЛЕВОЕ СОЕДИНЕНИЕ НастройкиВыполненияГодовойКорректировки КАК НастройкиВыполненияГодовойКорректировкиРайон
	|			ПО ВложенныйЗапрос.Организация = НастройкиВыполненияГодовойКорректировкиРайон.Организация
	|				И ВложенныйЗапрос.Район = НастройкиВыполненияГодовойКорректировкиРайон.Район
	|				И (НастройкиВыполненияГодовойКорректировкиРайон.МКД = ЗНАЧЕНИЕ(Справочник.энргСтроения.ПустаяСсылка))
	|	ГДЕ
	|		ВЫБОР
	|				КОГДА ВложенныйЗапрос.КорректировкаТекущегоПериода
	|					ТОГДА ИСТИНА
	|				ИНАЧЕ ЕСТЬNULL(НастройкиВыполненияГодовойКорректировкиМКД.Месяц, ЕСТЬNULL(НастройкиВыполненияГодовойКорректировкиРайон.Месяц, 1)) = МЕСЯЦ(&ПериодНАчисления)
	|			КОНЕЦ) КАК ВложенныйЗапрос
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	&ПериодНачисления КАК ПериодНачисления,
	|	&Район КАК Район,
	|	ВложенныйЗапрос.ЧастныйСектор КАК ЧастныйСектор,
	|	ВложенныйЗапрос.Строение КАК Строение,
	|	ВложенныйЗапрос.Помещение КАК Помещение,
	|	ВложенныйЗапрос.Абонент КАК Абонент,
	|	ВложенныйЗапрос.Услуга КАК Услуга,
	|	ВложенныйЗапрос.Поставщик КАК Поставщик,
	|	ВложенныйЗапрос.СуммаПотребленный - ВложенныйЗапрос.Сумма КАК СуммаКорректировки,
	|	&ЗавершениеОП КАК ЗавершениеОП,
	|	ВложенныйЗапрос.ОбъемУслугиПотребленный - ВложенныйЗапрос.ОбъемУслуги КАК ОбъемУслуги,
	|	ВложенныйЗапрос.ЗначениеТарифа КАК ЗначениеТарифа
	|ПОМЕСТИТЬ КорректируемыеОбъемы
	|ИЗ
	|	(ВЫБРАТЬ
	|		энргОбъемНачисленийОбороты.ЧастныйСектор КАК ЧастныйСектор,
	|		энргОбъемНачисленийОбороты.Строение КАК Строение,
	|		энргОбъемНачисленийОбороты.Помещение КАК Помещение,
	|		энргОбъемНачисленийОбороты.Абонент КАК Абонент,
	|		энргОбъемНачисленийОбороты.Услуга КАК Услуга,
	|		энргОбъемНачисленийОбороты.Поставщик КАК Поставщик,
	|		энргОбъемНачисленийОбороты.ЗначениеТарифа КАК ЗначениеТарифа,
	|		СУММА(энргОбъемНачисленийОбороты.СуммаОборот) КАК Сумма,
	|		СУММА(ВЫБОР
	|				КОГДА энргОбъемНачисленийОбороты.НеПрименятьСезонность
	|						И НЕ энргОбъемНачисленийОбороты.БылУстановленныйПриборВЭтомГоду
	|						И энргОбъемНачисленийОбороты.СпособНачисления = ЗНАЧЕНИЕ(Перечисление.энргСпособНачислений.СреднееПоНормативу)
	|					ТОГДА энргОбъемНачисленийОбороты.ОбъемУслугиОборот
	|				КОГДА энргОбъемНачисленийОбороты.НеПрименятьСезонность
	|						И НЕ энргОбъемНачисленийОбороты.БылУстановленныйПриборВЭтомГоду
	|						И энргОбъемНачисленийОбороты.СпособНачисления = ЗНАЧЕНИЕ(Перечисление.энргСпособНачислений.ПоНормативу)
	|					ТОГДА энргОбъемНачисленийОбороты.ОбъемУслугиОборот
	|				ИНАЧЕ энргОбъемНачисленийОбороты.ОбъемУслугиПотребленныйОборот
	|			КОНЕЦ * энргОбъемНачисленийОбороты.ЗначениеТарифа) КАК СуммаПотребленный,
	|		СУММА(энргОбъемНачисленийОбороты.ОбъемУслугиОборот) КАК ОбъемУслуги,
	|		СУММА(ВЫБОР
	|				КОГДА энргОбъемНачисленийОбороты.НеПрименятьСезонность
	|						И НЕ энргОбъемНачисленийОбороты.БылУстановленныйПриборВЭтомГоду
	|					ТОГДА энргОбъемНачисленийОбороты.ОбъемУслугиОборот
	|				ИНАЧЕ энргОбъемНачисленийОбороты.ОбъемУслугиПотребленныйОборот
	|			КОНЕЦ) КАК ОбъемУслугиПотребленный
	|	ИЗ
	|		РегистрНакопления.энргОбъемНачислений.Обороты(
	|				&НачалоГода,
	|				КОНЕЦПЕРИОДА(&ПериодНачисления, МЕСЯЦ),
	|				Год,
	|				Организация = &Организация
	|					И Район = &Район
	|					И НЕ(ВидНачисления = ЗНАЧЕНИЕ(Перечисление.энргВидыНачислений.Перерасчет)
	|							И СпособНачисления = ЗНАЧЕНИЕ(Перечисление.энргСпособНачислений.КорректировкаСезонныхУслуг))
	|					И ЧастныйСектор = &ЧастныйСектор
	|					И Строение = &Строение
	|					И Помещение = &Помещение) КАК энргОбъемНачисленийОбороты
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТочкиДляКорректировкиТекущийПериод КАК ТочкиДляКорректировки
	|			ПО энргОбъемНачисленийОбороты.ЧастныйСектор = ТочкиДляКорректировки.ЧастныйСектор
	|				И энргОбъемНачисленийОбороты.Строение = ТочкиДляКорректировки.Строение
	|				И энргОбъемНачисленийОбороты.Помещение = ТочкиДляКорректировки.Помещение
	|				И (ВЫБОР
	|					КОГДА НЕ ТочкиДляКорректировки.Абонент ЕСТЬ NULL
	|						ТОГДА энргОбъемНачисленийОбороты.Абонент = ТочкиДляКорректировки.Абонент
	|					ИНАЧЕ ИСТИНА
	|				КОНЕЦ)
	|				И энргОбъемНачисленийОбороты.Услуга = ТочкиДляКорректировки.Услуга
	|				И (ТочкиДляКорректировки.КорректировкаТекущегоПериода)
	|				И (энргОбъемНачисленийОбороты.ОбъемУслугиОборот <> энргОбъемНачисленийОбороты.ОбъемУслугиПотребленныйОборот)
	|	
	|	СГРУППИРОВАТЬ ПО
	|		энргОбъемНачисленийОбороты.ЧастныйСектор,
	|		энргОбъемНачисленийОбороты.Строение,
	|		энргОбъемНачисленийОбороты.Помещение,
	|		энргОбъемНачисленийОбороты.Абонент,
	|		энргОбъемНачисленийОбороты.Услуга,
	|		энргОбъемНачисленийОбороты.Поставщик,
	|		энргОбъемНачисленийОбороты.ЗначениеТарифа
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ВложенныйЗапрос.ЧастныйСектор,
	|		ВложенныйЗапрос.Строение,
	|		ВложенныйЗапрос.Помещение,
	|		ВложенныйЗапрос.Абонент,
	|		ВложенныйЗапрос.Услуга,
	|		ВложенныйЗапрос.Поставщик,
	|		ВложенныйЗапрос.ЗначениеТарифа,
	|		ВложенныйЗапрос.Сумма,
	|		ВложенныйЗапрос.СуммаПотребленный,
	|		ВложенныйЗапрос.ОбъемУслуги,
	|		ВложенныйЗапрос.ОбъемУслугиПотребленный
	|	ИЗ
	|		(ВЫБРАТЬ
	|			энргОбъемНачислений.ЧастныйСектор КАК ЧастныйСектор,
	|			энргОбъемНачислений.Строение КАК Строение,
	|			энргОбъемНачислений.Помещение КАК Помещение,
	|			энргОбъемНачислений.Абонент КАК Абонент,
	|			энргОбъемНачислений.Услуга КАК Услуга,
	|			энргОбъемНачислений.Поставщик КАК Поставщик,
	|			энргОбъемНачислений.ЗначениеТарифа КАК ЗначениеТарифа,
	|			СУММА(энргОбъемНачислений.Сумма) КАК Сумма,
	|			СУММА(ВЫБОР
	|					КОГДА энргОбъемНачислений.НеПрименятьСезонность
	|							И НЕ энргОбъемНачислений.БылУстановленныйПриборВЭтомГоду
	|							И энргОбъемНачислений.СпособНачисления = ЗНАЧЕНИЕ(Перечисление.энргСпособНачислений.СреднееПоНормативу)
	|						ТОГДА энргОбъемНачислений.ОбъемУслуги
	|					КОГДА энргОбъемНачислений.НеПрименятьСезонность
	|							И НЕ энргОбъемНачислений.БылУстановленныйПриборВЭтомГоду
	|							И энргОбъемНачислений.СпособНачисления = ЗНАЧЕНИЕ(Перечисление.энргСпособНачислений.ПоНормативу)
	|						ТОГДА энргОбъемНачислений.ОбъемУслуги
	|					ИНАЧЕ энргОбъемНачислений.ОбъемУслугиПотребленный
	|				КОНЕЦ * энргОбъемНачислений.ЗначениеТарифа) КАК СуммаПотребленный,
	|			СУММА(энргОбъемНачислений.ОбъемУслуги) КАК ОбъемУслуги,
	|			СУММА(ВЫБОР
	|					КОГДА энргОбъемНачислений.НеПрименятьСезонность
	|							И НЕ энргОбъемНачислений.БылУстановленныйПриборВЭтомГоду
	|							И энргОбъемНачислений.СпособНачисления = ЗНАЧЕНИЕ(Перечисление.энргСпособНачислений.СреднееПоНормативу)
	|						ТОГДА энргОбъемНачислений.ОбъемУслуги
	|					КОГДА энргОбъемНачислений.НеПрименятьСезонность
	|							И НЕ энргОбъемНачислений.БылУстановленныйПриборВЭтомГоду
	|							И энргОбъемНачислений.СпособНачисления = ЗНАЧЕНИЕ(Перечисление.энргСпособНачислений.ПоНормативу)
	|						ТОГДА энргОбъемНачислений.ОбъемУслуги
	|					ИНАЧЕ энргОбъемНачислений.ОбъемУслугиПотребленный
	|				КОНЕЦ) КАК ОбъемУслугиПотребленный,
	|			СУММА(энргОбъемНачислений.ОбъемУслугиПотребленный) КАК ОбъемУслугиПотребленныйИзРН
	|		ИЗ
	|			РегистрНакопления.энргОбъемНачислений КАК энргОбъемНачислений
	|				ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТочкиДляКорректировкиТекущийПериод КАК ТочкиДляКорректировки
	|				ПО энргОбъемНачислений.Период >= ТочкиДляКорректировки.НачалоПериода
	|					И (энргОбъемНачислений.Период <= КОНЕЦПЕРИОДА(ТочкиДляКорректировки.КонецПериода, МЕСЯЦ))
	|					И энргОбъемНачислений.Организация = ТочкиДляКорректировки.Организация
	|					И энргОбъемНачислений.Район = ТочкиДляКорректировки.Район
	|					И энргОбъемНачислений.ЧастныйСектор = ТочкиДляКорректировки.ЧастныйСектор
	|					И энргОбъемНачислений.Строение = ТочкиДляКорректировки.Строение
	|					И энргОбъемНачислений.Помещение = ТочкиДляКорректировки.Помещение
	|					И (ВЫБОР
	|						КОГДА НЕ ТочкиДляКорректировки.Абонент ЕСТЬ NULL
	|							ТОГДА энргОбъемНачислений.Абонент = ТочкиДляКорректировки.Абонент
	|						ИНАЧЕ ИСТИНА
	|					КОНЕЦ)
	|					И энргОбъемНачислений.Услуга = ТочкиДляКорректировки.Услуга
	|					И (НЕ ТочкиДляКорректировки.КорректировкаТекущегоПериода)
	|					И (энргОбъемНачислений.Организация = &Организация)
	|					И (энргОбъемНачислений.Район = &Район)
	|					И (энргОбъемНачислений.ЧастныйСектор = &ЧастныйСектор)
	|					И (энргОбъемНачислений.Строение = &Строение)
	|					И (энргОбъемНачислений.Помещение = &Помещение)
	|					И (НЕ(энргОбъемНачислений.ВидНачисления = ЗНАЧЕНИЕ(Перечисление.энргВидыНачислений.Перерасчет)
	|							И энргОбъемНачислений.СпособНачисления = ЗНАЧЕНИЕ(Перечисление.энргСпособНачислений.КорректировкаСезонныхУслуг)))
	|		
	|		СГРУППИРОВАТЬ ПО
	|			энргОбъемНачислений.ЧастныйСектор,
	|			энргОбъемНачислений.Строение,
	|			энргОбъемНачислений.Помещение,
	|			энргОбъемНачислений.Абонент,
	|			энргОбъемНачислений.Услуга,
	|			энргОбъемНачислений.Поставщик,
	|			энргОбъемНачислений.ЗначениеТарифа) КАК ВложенныйЗапрос
	|	ГДЕ
	|		ВложенныйЗапрос.ОбъемУслуги <> ВложенныйЗапрос.ОбъемУслугиПотребленныйИзРН) КАК ВложенныйЗапрос
	|ГДЕ
	|	ВЫБОР
	|			КОГДА ВложенныйЗапрос.СуммаПотребленный > ВложенныйЗапрос.Сумма
	|				ТОГДА ВложенныйЗапрос.СуммаПотребленный - ВложенныйЗапрос.Сумма > 1
	|			КОГДА ВложенныйЗапрос.СуммаПотребленный < ВложенныйЗапрос.Сумма
	|				ТОГДА ВложенныйЗапрос.Сумма - ВложенныйЗапрос.СуммаПотребленный > 1
	|			ИНАЧЕ ЛОЖЬ
	|		КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	энргДокументыНачислений.МКД КАК МКД,
	|	энргДокументыНачислений.ДокументНачисления КАК ДокументНачисления,
	|	энргДокументыНачислений.ПометкаУдаления КАК ПометкаУдаления
	|ПОМЕСТИТЬ ДокументыНачислений
	|ИЗ
	|	РегистрСведений.энргДокументыНачислений КАК энргДокументыНачислений
	|ГДЕ
	|	энргДокументыНачислений.Организация = &Организация
	|	И энргДокументыНачислений.ПериодНачисления = &ПериодНачисления
	|	И энргДокументыНачислений.Район = &Район
	|	И энргДокументыНачислений.ВидОперацийНачисления = ЗНАЧЕНИЕ(Перечисление.энргВидыОперацийНачисления.КорректировкаПотребленияСезонныхУслуг)
	|	И энргДокументыНачислений.МКД = &МКД";
	
	Возврат Текст;
	
КонецФункции

Функция ТекстЗапросаДанныеДляКорректировкаПотребленияСезонныхУслуг()
	
	Текст  = 
	"ВЫБРАТЬ
	|	КорректируемыеОбъемы.Организация КАК Организация,
	|	КорректируемыеОбъемы.ПериодНачисления КАК ПериодНачисления,
	|	КорректируемыеОбъемы.ПериодНачисления КАК ПериодРасчета,
	|	КорректируемыеОбъемы.Район КАК Район,
	|	КорректируемыеОбъемы.ЧастныйСектор КАК ЧастныйСектор,
	|	КорректируемыеОбъемы.Строение КАК Строение,
	|	КорректируемыеОбъемы.Помещение КАК Помещение,
	|	КорректируемыеОбъемы.Абонент КАК Абонент,
	|	КорректируемыеОбъемы.Услуга КАК Услуга,
	|	ЗНАЧЕНИЕ(Перечисление.энргВидыНачислений.Перерасчет) КАК ВидНачисления,
	|	ЗНАЧЕНИЕ(Перечисление.энргСпособНачислений.КорректировкаСезонныхУслуг) КАК СпособНачисления,
	|	КорректируемыеОбъемы.Поставщик КАК Поставщик,
	|	КорректируемыеОбъемы.СуммаКорректировки КАК Сумма,
	|	ВЫБОР
	|		КОГДА КорректируемыеОбъемы.ЧастныйСектор
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.энргСтроения.ПустаяСсылка)
	|		ИНАЧЕ КорректируемыеОбъемы.Строение
	|	КОНЕЦ КАК МКД,
	|	ЕСТЬNULL(ДокументыНачислений.ДокументНачисления, ЗНАЧЕНИЕ(Документ.энргПерерасчет.ПустаяСсылка)) КАК ДокументНачисления,
	|	ЕСТЬNULL(ДокументыНачислений.ПометкаУдаления, ЛОЖЬ) КАК ДокументНачисленияПометкаУдаления,
	|	КорректируемыеОбъемы.ЗавершениеОП КАК ЗавершениеОП,
	|	КорректируемыеОбъемы.ОбъемУслуги КАК ОбъемУслуги,
	|	КорректируемыеОбъемы.ЗначениеТарифа КАК ЗначениеТарифа
	|ИЗ
	|	КорректируемыеОбъемы КАК КорректируемыеОбъемы
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДокументыНачислений КАК ДокументыНачислений
	|		ПО (ВЫБОР
	|				КОГДА КорректируемыеОбъемы.ЧастныйСектор
	|					ТОГДА ЗНАЧЕНИЕ(Справочник.энргСтроения.ПустаяСсылка)
	|				ИНАЧЕ КорректируемыеОбъемы.Строение
	|			КОНЕЦ = ДокументыНачислений.МКД)";
	
	Возврат Текст;
	
КонецФункции

Функция ТекстЗапросаИзменитьПризнакСостояниеПрибора()
	
	Текст =
	"ВЫБРАТЬ
	|	ВложенныйЗапрос.*,
	|	ЕСТЬNULL(ДокументыПерерасчета.ДокументНачисления, ЗНАЧЕНИЕ(Документ.энргПерерасчет.ПустаяСсылка)) КАК ДокументНачисления,
	|	ЕСТЬNULL(ДокументыПерерасчета.ПометкаУдаления, ЛОЖЬ) КАК ДокументНачисленияПометкаУдаления
	|ИЗ
	|	(ВЫБРАТЬ
	|		НаборЗаписейОбъемаНачисленийЗаПериод.*,
	|		ВложенныйЗапрос.МКД КАК МКД,
	|		ВложенныйЗапрос.ПериодРасчета КАК ПериодРасчета,
	|		ВложенныйЗапрос.ЗавершениеОП КАК ЗавершениеОП
	|	ИЗ
	|		НаборЗаписейОбъемаНачисленийЗаПериод КАК НаборЗаписейОбъемаНачисленийЗаПериод
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|				ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.Организация КАК Организация,
	|				ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.ПериодНачисления КАК ПериодНачисления,
	|				ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.Район КАК Район,
	|				ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.МКД КАК МКД,
	|				ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.ЧастныйСектор КАК ЧастныйСектор,
	|				ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.Строение КАК Строение,
	|				ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.Помещение КАК Помещение,
	|				ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.Услуга КАК Услуга,
	|				ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.ТочкаУчета КАК ТочкаУчета,
	|				ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.НаправлениеИспользованияТУ КАК НаправлениеИспользованияТУ,
	|				ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.ЗавершениеОП КАК ЗавершениеОП,
	|				ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.ПериодНачисления КАК ПериодРасчета
	|			ИЗ
	|				ТочкиУчетаСИзменившимсяСостояниемПрибораУчета КАК ТочкиУчетаСИзменившимсяСостояниемПрибораУчета
	|					ЛЕВОЕ СОЕДИНЕНИЕ НастройкаСезонностиУслуг КАК НастройкаСезонностиУслугРайон
	|					ПО ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.Организация = НастройкаСезонностиУслугРайон.Организация
	|						И ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.Район = НастройкаСезонностиУслугРайон.Район
	|						И ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.Услуга = НастройкаСезонностиУслугРайон.Услуга
	|						И ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.НаправлениеИспользованияТУ = НастройкаСезонностиУслугРайон.НаправлениеИспользованияТУ
	|						И (НастройкаСезонностиУслугРайон.МКД = ЗНАЧЕНИЕ(Справочник.энргСтроения.ПустаяСсылка))
	|					ЛЕВОЕ СОЕДИНЕНИЕ НастройкаСезонностиУслуг КАК НастройкаСезонностиУслугМКД
	|					ПО ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.Организация = НастройкаСезонностиУслугМКД.Организация
	|						И ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.Район = НастройкаСезонностиУслугМКД.Район
	|						И ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.Услуга = НастройкаСезонностиУслугМКД.Услуга
	|						И ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.НаправлениеИспользованияТУ = НастройкаСезонностиУслугМКД.НаправлениеИспользованияТУ
	|						И ТочкиУчетаСИзменившимсяСостояниемПрибораУчета.МКД = НастройкаСезонностиУслугМКД.МКД
	|			ГДЕ
	|				ЕСТЬNULL(НастройкаСезонностиУслугРайон.КорректироватьГодовойОбъем, ЕСТЬNULL(НастройкаСезонностиУслугМКД.КорректироватьГодовойОбъем, ЛОЖЬ))
	|				И ЕСТЬNULL(НастройкаСезонностиУслугРайон.НеПрименятьСезонность, ЕСТЬNULL(НастройкаСезонностиУслугМКД.НеПрименятьСезонность, ЛОЖЬ))) КАК ВложенныйЗапрос
	|			ПО НаборЗаписейОбъемаНачисленийЗаПериод.Организация = ВложенныйЗапрос.Организация
	|				И НаборЗаписейОбъемаНачисленийЗаПериод.Район = ВложенныйЗапрос.Район
	|				И НаборЗаписейОбъемаНачисленийЗаПериод.Строение = ВложенныйЗапрос.Строение
	|				И НаборЗаписейОбъемаНачисленийЗаПериод.Помещение = ВложенныйЗапрос.Помещение
	|				И НаборЗаписейОбъемаНачисленийЗаПериод.Услуга = ВложенныйЗапрос.Услуга
	|				И НаборЗаписейОбъемаНачисленийЗаПериод.ТочкаУчета = ВложенныйЗапрос.ТочкаУчета
	|				И НаборЗаписейОбъемаНачисленийЗаПериод.НаправлениеИспользованияТУ = ВложенныйЗапрос.НаправлениеИспользованияТУ
	|				И (НЕ НаборЗаписейОбъемаНачисленийЗаПериод.БылУстановленныйПриборВЭтомГоду)) КАК ВложенныйЗапрос
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДокументыПерерасчета КАК ДокументыПерерасчета
	|		ПО ВложенныйЗапрос.Организация = ДокументыПерерасчета.Организация
	|			И ВложенныйЗапрос.Район = ДокументыПерерасчета.Район
	|			И ВложенныйЗапрос.МКД = ДокументыПерерасчета.МКД
	|
	|УПОРЯДОЧИТЬ ПО
	|	ВложенныйЗапрос.Организация,
	|	ВложенныйЗапрос.Район,
	|	ВложенныйЗапрос.МКД";
	
	Возврат Текст;
	
КонецФункции

#КонецОбласти